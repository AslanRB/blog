---
title: FreqStats 1
author: 'Aslan Bellmann'
date: '2020-12-06'
slug: freqstats1
categories: []
tags: []
---

```{r setup, include=F}
knitr::opts_chunk$set(echo    = F,
                      message = F,
                      warning = F,
                      fig.width = 5,
                      fig.height = 3,
                      fig.align = "center")

library(knitr)
library(tidyverse)
library(patchwork)
```


Usually most of the information is in the text, and plots are used to highlight the key information. Not in this. Here, I tried to put ALL the informaton in the plots. For the most part, you could just go from plot to plot, looking at each one until you understand what is going on, and you got all the information -- and I encourage you to do so. If it doesn't work, the information is also in the text. Bla


| Truth ---------| Decision ----------| Event ----------------------| Rate --------| Also known as -----------|
|----------------|--------------------|-----------------------------|--------------|--------------------------|
|$\mu_0 = \mu$   | Reject             | False positive error        | $\alpha$     | 'significance threshold' |
|                | Don't Reject       | True negative               | $1-\alpha$   | 'coverage probability'   |
|$\mu_0 \ne \mu$ | Reject             | True positive               | $1-\beta$    | 'statistical power'      |
|                | Don't Reject       | False negative error        | $\beta$      |                          |

# Probability in Frequentist Statistics
Mathematically, probability is just some quantitiy defined through the _Kolmogorov axioms_. From these axioms, we can derive further mathematical rules of probability. So far so good. However, once we expand our horizons beyond the abstract definition to the real-world application, we suddenly have to deal with multiple interpretations of probability. This can cause a great deal of confusion, so let's be clear about what interpretation of probability we will use throughout this blogpost... 

The name gives it away: In frequentist statistics, probabilities refer to _frequencies_, aka _rates_. That is, the probability that an event produces an outcome is the frequency (rate) at which that event produces that outcome if the event is repeated infinitely many times. And because I don't want to repeat the phrase 'if the event is repeated infinitely many times' itself infinitely many times, I will from now on just say _in the long-run_. So, the probability that an event produces an outcome is the frequecy (rate) at which that event produces that outcome in the long-run.

For example, what is the probability that flipping a coin will get you tails? The figure below shows the proportion of tails you have observed after each coin flip, for the first 100 flips. As the number of flips tends towards infinity, the proportion of tails converges on 0.5. Thus, the probability of getting tails is 0.5 -- you'll get tails 50% of the time in the long-run. (Below, the proportion of tails already seems to converge on 0.5 with the first 100 flips, but this is not reliable. To get a reliable estimate of the probability, we'd need more like 10,000+ repetitions). 

```{r coin flip plot, fig.height=2, fig.width=5}
set.seed(5)
flips = 100; tails = rbinom(flips,1,0.5); ctails = vector(length=flips)
for(i in seq_along(tails)){ctails[i] = mean(tails[1:i])}

data.frame(index=1:flips, ctails) %>%
  ggplot(aes(x=index, y=ctails))+
  geom_hline(size=0.5, yintercept=0.5, color="red", linetype="dashed")+
  geom_line(size=1, color="black")+
  geom_point(size=1, shape=21, color="black", fill="white")+
  scale_x_continuous(name="# Coin Flips")+
  scale_y_continuous(name="Proportion of Tails", limits=c(0,1), breaks=c(0,0.5,1))+
  theme_bw()+
  theme(panel.grid=element_blank())
```

Under the _frequentist_ account of probability, we can only distribute probability over outcomes of events that are (in principle) repeatable -- such as whether a coin flip will yield tails, or whether three cards that you draw from a well-shuffled deck will have the same color. We cannot assign probability to non-repeatable events -- such as whether time travel is possible, or whether it will rain tomorrow. Under an _epistemic_ account of probability, where probability may quantify a rational agent's degree of belief, we absolutely could assign probability to non-repeatable events. But not under the _frequentist_ account. 

To avoid confusion, I will just use the words 'rate' or 'frequency' instead of 'probability' -- at least most of the time.

# The Working Scenario
We are interested in some continuous variable, $X$ -- if you prefer you can mentally insert something specific such as height, weight, or age. We will assume that $X$ is normally distributed within the population with mean $\mu$ and standard deviation $\sigma$, i.e. $X \sim {\sf Normal}(\mu,\sigma)$. We are interested in the population mean $\mu$. For now, we will assume that we know the population standard deviation $\sigma$ (this is pretty much never the case in reality, but it makes things easier to explain). Unfortunately, we cannot obtain the precise value of $\mu$ by simply measuring the whole population. However, we can draw a random sample from the population and use it to construct an interval that should contain $\mu$.

```{r overview plot, fig.height=2.5, fig.width=5}
set.seed(4)

P = with(density(rnorm(50000, mean=-100, sd=20)), data.frame(x,y))
S = data.frame(x=rnorm(n=15, mean=100, sd=20), y=rep(0, 15))
m = mean(S$x)

ggplot()+
  # Population
  geom_area(data=P, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_segment(aes(x=-100, xend=-100, y=-.002, yend=0.02), size=1, color="navy", linetype="dashed")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=-100, y=-0.003, label="mu", color="navy")+
  # Sample
  geom_point(data=S, aes(x=x, y=y), shape=21, size=3, stroke=1.5, color="black", fill="gray85", position=position_jitter(h=0.002))+
  # CI
  geom_segment(aes(x=-120, xend=-90, y=-0.015, yend=-0.015), size=1.5, color="darkred")+
  # Arrows
  geom_curve(aes(x=-50, xend=50, y=0.015, yend=0.01), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  geom_curve(aes(x=50, xend=-50, y=-0.01, yend=-0.015), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  # Text 
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=0.025, label="'Q: What is the population mean,'~mu~'?'", color="navy")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.025, label="'A: It is somewhere in the red interval.'", color="darkred")+
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=-100, y=0.035, label="'POPULATION'")+
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=80, y=0.035, label="'RANDOM SAMPLE'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.010, label="~mu~' (mean)'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.005, label="~sigma~' (stdev)'")+
  # Dotted Line
  geom_segment(aes(x=0, xend=0, y=0.04, yend=0.018), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=0.012, yend=-0.012), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=-0.018, yend=-0.04), size=0.5, linetype="dotted")+
  # x-axis population
  geom_segment(aes(x=-150, xend=-50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(-140,-60,10), xend=seq(-140,-60,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=-100, y=-0.035-0.002)+
  # x-axis sample
  geom_segment(aes(x=m-50, xend=m+50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(m-40,m+40,10), xend=seq(m-40,m+40,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=m, y=-0.035-0.002)+
  # Design
  scale_y_continuous(limits=c(-0.04,0.04), name="")+scale_x_continuous(limits=c(-200,150))+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank())
```

More specifically, we draw a random sample of size $N$. We can measure the sample and calculate the sample mean $m$ and the sample standard deviation $s$. Remember, our goal is to estimate $\mu$. We do this by rejecting all hypothetical values of $\mu$ that are incompatible with our sample data ($m$ and $s$), thereby obtaining an interval of non-rejected values of $\mu$.

I want to emphasize that frequentist statistics is really all about rejection. Imagine you are at the supermarket and you want to buy an apple. However, not all the apples are of the same quality -- and of course you want the single best one available. You start visually inspecting all the apples, rejecting the ones that don't look fresh. You end up with a bunch of non-rejected apples. Among them is the best available apple -- but you don't know which one exactly; you have just narrowed it down. 

This is pretty much what we are doing. Instead of the best available apple, we care about the true value of $\mu$. Instead of rejecting apples, we reject hypothetical values of $\mu$. Instead of apple aesthetics, we use incompatibility with our sample data as a rejection criterion. Now, the obvious question is: What does 'incompatibility with our sample data' mean? How exactly do we construct the interval?


```{r overview plot estimation, fig.height=2.5, fig.width=5}
ggplot()+
  # Population
  geom_area(data=P, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_segment(aes(x=-100, xend=-100, y=-.002, yend=0.02), size=1, color="navy", linetype="dashed")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=-100, y=-0.003, label="mu", color="navy")+
  # Sample
  geom_point(data=S, aes(x=x, y=y), shape=21, size=3, stroke=1.5, color="black", fill="gray85", position=position_jitter(h=0.002))+
  # CI
  geom_segment(aes(x=-120, xend=-90, y=-0.015, yend=-0.015), size=1.5, color="darkred")+
  # Arrows
  geom_curve(aes(x=-50, xend=50, y=0.015, yend=0.01), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  geom_curve(aes(x=50, xend=-50, y=-0.01, yend=-0.015), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  # Text 
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=0.025, label="'Task: Estimate'~mu~'.'", color="navy")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.016, label="'Result: Interval'", color="darkred")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.021, label="'of'~bold('non-rejected values')~'for '~mu~'.'", color="darkred")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.010, label="~mu~' (mean)'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.005, label="~sigma~' (stdev)'")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=65, y=0.010, label="~m~' (mean)'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=65, y=0.005, label="~s~'  (stdev)'")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=+0.017, label="'Draw sample of size N.'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.022, label="'Narrow down '~mu~' by'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.026, label="bold('rejecting values')~'which are'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.030, label="bold('incompatible')~'with the sample data.'")+
  
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=-100, y=0.035, label="'POPULATION'")+
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=80, y=0.035, label="'RANDOM SAMPLE'")+
  # Dotted Line
  geom_segment(aes(x=0, xend=0, y=0.04, yend=0.022), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=0.012, yend=-0.012), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=-0.033, yend=-0.04), size=0.5, linetype="dotted")+
  # x-axis population
  geom_segment(aes(x=-150, xend=-50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(-140,-60,10), xend=seq(-140,-60,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=-100, y=-0.035-0.002)+
  # x-axis sample
  geom_segment(aes(x=m-50, xend=m+50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(m-40,m+40,10), xend=seq(m-40,m+40,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=m, y=-0.035-0.002)+
  # Design
  scale_y_continuous(limits=c(-0.04,0.04), name="")+
  scale_x_continuous(limits=c(-200,150))+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank())

```


# Sampling Distributions

To get there, we need to understand what a sampling distribution is. We start with a population distribution, from which we repeatedly draw samples of size $N$. Each time we draw a sample, we calculate and plot the sample mean $m$. As the $m$'s accumulate, they form a distribution themselves. In the limit where the number of samples we draw (and thus the number of $m$'s we plot) tends towards infinity, this distribution is the sampling distribution of the sample mean $m$. 

_Aside: Sampling distributions exist for any sample statistic. For example, instead of the mean $m$, we could calculate and plot the standard deviation $s$ for each sample. As the number of samples we draw (and thus the number of $s$'s) tends towards infinity, we obtain the sampling distribution of the sample standard deviation $s$._

The sampling distribution of the sample mean $m$ is illustrated below, for three different sample sizes $N$. The top panel shows the first five samples and their sample means $m$. The bottom panel shows the distributions of $m$ from 100,000 samples (a good approximation of what the distribution looks like as the number of samples tends towards infinity).

```{r sampdist plot, fig.height=4.2, fig.width=5}
set.seed(5)

mu=100; sigma=10; N=c(5, 15, 50); reps=100000

samdists= rbind(with(density(rnorm(reps,mu,sigma)), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[1],mu,sigma)))), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[2],mu,sigma)))), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[3],mu,sigma)))), data.frame(x,y)))

samdists$l = rep(c("Population", "N = 5", "N = 15", "N = 50"), each=512) #512 is length of density()
samdists$l = factor(samdists$l, levels=c("N = 50", "N = 15", "N = 5", "Population"))

legend = ggplot()+
  theme_bw()+
  theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), panel.grid=element_blank())+
  theme_void()+
  coord_fixed()+
  scale_x_continuous(limits=c(0,8))+
  scale_y_continuous(limits=c(0,6))+
  annotate("rect", xmin=0, xmax=0.8, ymin=4, ymax=4.8, size=1, alpha=0.2, fill=NA, color="darkorange")+
  annotate("rect", xmin=0, xmax=0.8, ymin=3, ymax=3.8, size=1, alpha=0.2, fill=NA, color="darkred")+
  annotate("rect", xmin=0, xmax=0.8, ymin=2, ymax=2.8, size=1, alpha=0.2, fill=NA, color="purple4")+
  annotate("rect", xmin=0, xmax=0.8, ymin=0, ymax=0.8, size=1, alpha=0.2, fill="gray40", color="black")+
  
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=4.4, label="N = 50")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=3.4, label="N = 15")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=2.4, label="N =  5")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=0.4, label=expression(paste("Normal (",mu,", ",sigma,")")))+
  annotate("text", hjust=0, vjust=0.5, size=3, x=3.4, y=3.3, label=expression(paste("Normal (",mu,", ",frac(sigma,sqrt(N)),")")))+
  
  geom_segment(size=0.5, linetype="dotted", aes(x=3.3, xend=3.3, y=2, yend=4.8))+
  
  annotate("text", hjust=0, vjust=0, size=3, x=0, y=5.1, label=expression(bold("Distributions of m")))+
  annotate("text", hjust=0, vjust=0, size=3, x=0, y=1, label=expression(bold("Population")))

p.samdists = ggplot(data=samdists, aes(x=x, y=y, color=l, fill=l))+
  geom_segment(aes(x=mu,xend=mu,y=-0.01,yend=max(samdists$y)), size=1, color="navy", linetype="dashed")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=-0.02, label="mu", color="navy")+
  geom_area(size=1, alpha=0.2)+
  scale_fill_manual(values=c(NA,NA,NA,"gray40"), name="") +
  scale_color_manual(values=c("darkorange","darkred","purple4","black"), name="")+
  scale_x_continuous(name="X", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="Probability Density", limits=c(-0.05,NA))+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")+
  annotation_custom(ggplotGrob(legend), ymin=0.02, ymax=0.28, xmin=mu-3*sigma, xmax=95)

s1 = data.frame(x=c(rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma)),
                y=rep(1:5), each=N[1]) #5 samples
s2 = data.frame(x=c(rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma)),
                y=rep(1:5), each=N[2])
s3 = data.frame(x=c(rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma)),
                y=rep(1:5), each=N[3])

m1 = tapply(s1$x, s1$y, mean); m1 = data.frame(x=m1, y=1:5)
m2 = tapply(s2$x, s2$y, mean); m2 = data.frame(x=m2, y=1:5)
m3 = tapply(s3$x, s3$y, mean); m3 = data.frame(x=m3, y=1:5)

p.N1 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s1, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m1, aes(x=x,y=y), shape=22, size=4, color="black", fill="purple4")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="Sample #", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        aspect.ratio=1.2) #sufficient to set for one plot of the row

p.N2 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s2, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m2, aes(x=x,y=y), shape=22, size=4, color="black", fill="darkred")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank())

p.N3 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s3, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m3, aes(x=x,y=y), shape=22, size=4, color="black", fill="darkorange")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank())

(p.N1|p.N2|p.N3) / p.samdists
```

As you can see in the plot, the sampling distribution of $m$ has three key properties: $m \sim {\sf Normal}(\mu,\frac{\sigma}{\sqrt{N}})$. 

1. The distribution of $m$ is normal,
2. the mean of the distribution is the population mean $\mu$,
3. the standard deviation of the distribution is $\frac{\sigma}{\sqrt{N}}$ (aka the standard error of the mean), and thus decreases as $N$ increases. 

_Aside: The above points hold true as long as the population distribution has a mean $\mu$ and finite variance $\sigma^2$ -- the population distribution doesn't have to be a normal distribution as in our example._

With that, let's see how we can use the sampling distribution of the mean to estimate $\mu$.

# $p$-values

Recall that we reject hypothetical values for $\mu$ if they are incompatible with our sample data. So how do we quantify (in)compatibility? Via the $p$-value! The $p$-value can take any number from 0 to 1. The lower the $p$-value for a given hypothetical value for $\mu$, the less compatible that hypothetical value for $\mu$ is with our sample data.

In what follows, we will draw a sample of $N=15$ and compute p-values using the corresponding sampling distribution of $m$. We will compute three types of p-values: right-sided, left-sided, and two-sided. I tried to make the plots pretty self-explanatory, so I encourage you to look at each plot, try to figure out what's going on, and then read my comments.

### Computing and interpreting the right-sided $p$-value
We start with the right-sided $p$-value. Check out the plot below...

The __top two panels__ show our building blocks:  

1. The sampling distribution of $m$ (red) for our sample size $N$.
2. The sampling distribution of $m$ (red) and the population distribution (grey) have a common mean $\mu$.
3. Our sample mean $m$ (red square with black solid vertical line).

```{r rightsided pvalue plot, fig.height=6.3, fig.width=5}
set.seed(5)
mu=100; sigma=10; N=15; reps=100000

sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)) #sample 

popdis = with(density(rnorm(reps,0,sigma)), data.frame(x,y)) #popdis centred on zero
samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y)) #samdis centred on zero

pvals = c(0.7, 0.3, 0.1)

shift = mean(sample$x) + qnorm(pvals, lower.tail=T) * (sigma/sqrt(N))

samdis$x1 = samdis$x + shift[1]
samdis$x2 = samdis$x + shift[2]
samdis$x3 = samdis$x + shift[3]

p.pop = ggplot()+
  geom_area(data=popdis, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_area(data=samdis, aes(x=x, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=c(-30,30), breaks=seq(-20,20,10), name=expression(paste("Distance from ",mu,"")))+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.p1 = ggplot(data=samdis, aes(x=x1, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x1>mean(sample$x),x1,NA)))+
  geom_vline(xintercept=shift[1], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.7")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p2 = ggplot(data=samdis, aes(x=x2, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x2>mean(sample$x),x2,NA)))+
  geom_vline(xintercept=shift[2], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.3")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p3 = ggplot(data=samdis, aes(x=x3, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x3>mean(sample$x),x3,NA)))+
  geom_vline(xintercept=shift[3], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.1")), hjust=0, vjust=0.5, x=112, y=0.08)

x = c(seq(70,130,0.05), mean(sample$x))
p = vector(length=length(x))

for (i in 1:length(x)){
  p[i] = pnorm(x[i],mean(sample$x),sigma/sqrt(N))
}
pcurve.rs = data.frame(x,p)

p.pcurve = ggplot(data=pcurve.rs, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[1], xend=70, y=pvals[1], yend=pvals[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[2], xend=70, y=pvals[2], yend=pvals[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[3], xend=70, y=pvals[3], yend=pvals[3]), color="black")+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.p1 / p.p2 / p.p3 / p.pcurve

```

The __next three panels__ show how right-sided $p$-values are computed for three hypothetical values of $\mu$. Here are the two steps:

1. We center the sampling distribution of $m$ over the hypothetical value of $\mu$ (blue dashed line). By doing so, we assume that the value of $\mu$ is indeed that hypothetical value (blue dashed line) -- see building block 2 above.
2. The _right_-sided $p$-value is the area of the sampling distribution of $m$ that is _right_ to our sample mean $m$ (black solid line). Recall that the sampling distribution of $m$  represents a 'number-approaching-infinity' amount of $m$'s, each obtained from a random sample of size $N$. Thus, the area _right_ to our sample mean $m$ tells us how often we would observe an $m$ _at least as large_ as ours, if we drew 'number-approaching-infinity' samples of size $N$.

That is, the _right_-sided $p$-value for a hypothetical value of $\mu$ means: If $\mu$ were indeed this hypothetical value, we would observe a sample mean $m$ _at least as large_ as the one we observed in our sample $p \times 100 \%$ of the time -- if we drew 'number-approaching-infinity' samples of size $N$.

The __bottom panel__ shows _right_-sided $p$-values for a range of hypothetical values of $\mu$ (often referred to as a $p$-value curve).

### Computing and interpreting the left-sided $p$-value
Let's move on to the left-sided $p$-value. Check out the plot below...

The __top two panels__ show our building blocks (same as before):  

1. The sampling distribution of $m$ (red) for our sample size $N$.
2. The sampling distribution of $m$ (red) and the population distribution (grey) have a common mean $\mu$.
3. Our sample mean $m$ (red square with black solid vertical line).

```{r leftsided pvalue plot, fig.height=6.3, fig.width=5}
set.seed(5)
mu=100; sigma=10; N=15; reps=100000

sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)) #sample 

popdis = with(density(rnorm(reps,0,sigma)), data.frame(x,y)) #popdis centred on zero
samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y)) #samdis centred on zero

pvals = 1-c(0.7, 0.3, 0.1)

shift = mean(sample$x) + qnorm(pvals, lower.tail=F) * (sigma/sqrt(N))
samdis$x1 = samdis$x + shift[1]
samdis$x2 = samdis$x + shift[2]
samdis$x3 = samdis$x + shift[3]

p.pop = ggplot()+
  geom_area(data=popdis, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_area(data=samdis, aes(x=x, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=c(-30,30), breaks=seq(-20,20,10), name=expression(paste("Distance from ",mu,"")))+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.p1 = ggplot(data=samdis, aes(x=x1, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x1<mean(sample$x),x1,NA)))+
  geom_vline(xintercept=shift[1], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.3")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p2 = ggplot(data=samdis, aes(x=x2, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x2<mean(sample$x),x2,NA)))+
  geom_vline(xintercept=shift[2], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.7")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p3 = ggplot(data=samdis, aes(x=x3, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x3<mean(sample$x),x3,NA)))+
  geom_vline(xintercept=shift[3], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  annotate("text", size=3, label=expression(paste("   =  p  =  0.9")), hjust=0, vjust=0.5, x=112, y=0.08)

x = c(seq(70,130,0.05), mean(sample$x))
p = vector(length=length(x))

for (i in 1:length(x)){
  p[i] = pnorm(-x[i],-mean(sample$x),sigma/sqrt(N))
}
pcurve.ls = data.frame(x,p)

p.pcurve = ggplot(data=pcurve.ls, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[1], xend=70, y=pvals[1], yend=pvals[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[2], xend=70, y=pvals[2], yend=pvals[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[3], xend=70, y=pvals[3], yend=pvals[3]), color="black")+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.p1 / p.p2 / p.p3 / p.pcurve

```

The __next three panels__ show how right-sided $p$-values are computed for (the same) three hypothetical values of $\mu$. Here are the two steps:

1. We center the sampling distribution of $m$ over the hypothetical value of $\mu$ (blue dashed line). By doing so, we assume that the value of $\mu$ is indeed that hypothetical value (blue dashed line) -- see building block 2 above.
2. The _left_-sided $p$-value is the area of the sampling distribution of $m$ that is _left_ to our sample mean $m$ (black solid line). Recall that the sampling distribution of $m$  represents a 'number-approaching-infinity' amount of $m$'s, each obtained from a random sample of size $N$. Thus, the area _left_ to our sample mean $m$ tells us how often we would observe an $m$ _at least as small_ as ours, if we drew 'number-approaching-infinity' samples of size $N$.

That is, the _left_-sided $p$-value for a hypothetical value of $\mu$ means: If $\mu$ were indeed this hypothetical value, we would observe a sample mean $m$ _at least as small_ as the one we observed in our sample $p \times 100 \%$ of the time -- if we drew 'number-approaching-infinity' samples of size $N$.

The __bottom panel__ shows _left_-sided $p$-values for a range of hypothetical values of $\mu$ (often referred to as a $p$-value curve). Note how the _left_-sided $p$-value curve and the _right_-sided $p$-value curve are horizontal mirror images. 

### Computing and interpreting the two-sided $p$-value
Let's move on to the two-sided $p$-value. Check out the plot below...

The __top two panels__ show our building blocks (same as before):  

1. The sampling distribution of $m$ (red) for our sample size $N$.
2. The sampling distribution of $m$ (red) and the population distribution (grey) have a common mean $\mu$.
3. Our sample mean $m$ (red square with black solid vertical line).

```{r twosided pvalue plot, fig.height=6.3, fig.width=5}
set.seed(5)
mu=100; sigma=10; N=15; reps=100000

sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)) #sample 

popdis = with(density(rnorm(reps,0,sigma)), data.frame(x,y)) #popdis centred on zero
samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y)) #samdis centred on zero

pvals = 2*c((1-0.7), 0.3, 0.1); side = c("R","L","L") #don't forget to adjust appropriately if area left or right to sample mean is shaded in plot

shift = c(0,0,0); for(i in seq_along(side)){
  if(side[i]=="R"){shift[i] = mean(sample$x) + qnorm(pvals[i]/2, lower.tail=F) * (sigma/sqrt(N))} #left-sided p * 2
  else if(side[i]=="L"){shift[i] = mean(sample$x) + qnorm(pvals[i]/2, lower.tail=T) * (sigma/sqrt(N))}} #right-sided p * 2

samdis$x1 = samdis$x + shift[1]
samdis$x2 = samdis$x + shift[2]
samdis$x3 = samdis$x + shift[3]

p.pop = ggplot()+
  geom_area(data=popdis, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_area(data=samdis, aes(x=x, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=c(-30,30), breaks=seq(-20,20,10), name=expression(paste("Distance from ",mu,"")))+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.p1 = ggplot(data=samdis, aes(x=x1, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x1<mean(sample$x),x1,NA)))+
  geom_vline(xintercept=shift[1], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  #annotate("text", size=3, label=expression(paste("   =  ",frac(p,2),"  =  0.4 .... p  =  0.8")), hjust=0, vjust=0.5, x=112, y=0.08)
  annotate("text", size=3, label=expression(paste("  * 2  =  p  =  0.6")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p2 = ggplot(data=samdis, aes(x=x2, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x2>mean(sample$x),x2,NA)))+
  geom_vline(xintercept=shift[2], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  #annotate("text", size=3, label=expression(paste("   =  ",frac(p,2),"  =  0.15 .... p  =  0.3")), hjust=0, vjust=0.5, x=112, y=0.08)
  annotate("text", size=3, label=expression(paste("  * 2  =  p  =  0.6")), hjust=0, vjust=0.5, x=112, y=0.08)


p.p3 = ggplot(data=samdis, aes(x=x3, y=y))+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x3>mean(sample$x),x3,NA)))+
  geom_vline(xintercept=shift[3], color="navy", linetype="dashed")+
  geom_vline(xintercept=mean(sample$x))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=110, xmax=112, ymin=0.06, ymax=0.10)+
  #annotate("text", size=3, label=expression(paste("   =  ",frac(p,2),"  =  0.025 .... p  =  0.05")), hjust=0, vjust=0.5, x=112, y=0.08)
  annotate("text", size=3, label=expression(paste("  * 2  =  p  =  0.2")), hjust=0, vjust=0.5, x=112, y=0.08)

x = c(seq(70,130,0.05), mean(sample$x))
p = vector(length=length(x))

for (i in 1:length(x)){
  if (x[i] < mean(sample$x)){
    p[i] = pnorm(x[i],mean(sample$x),sigma/sqrt(N)) * 2}
  else {
    p[i] = (1 - pnorm(x[i],mean(sample$x),sigma/sqrt(N))) * 2}
}
pcurve.2s = data.frame(x,p)

p.pcurve = ggplot(data=pcurve.2s, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[1], xend=70, y=pvals[1], yend=pvals[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[2], xend=70, y=pvals[2], yend=pvals[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=shift[3], xend=70, y=pvals[3], yend=pvals[3]), color="black")+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.p1 / p.p2 / p.p3 / p.pcurve

```

The __next three panels__ show how two-sided $p$-values are computed for the same three hypothetical values of $\mu$ as before. Namely, both a left-sided $p$-value and a right-sided $p$-value are computed, the minimum of the two is taken, and then multiplied by two because we used the sampling distribution twice. Here are the two steps:

1. We center the sampling distribution of $m$ over the hypothetical value of $\mu$ (blue dashed line). By doing so, we assume that the value of $\mu$ is indeed that hypothetical value (blue dashed line) -- see building block 2 above.
2. The _two_-sided $p$-value is _twice_ the area of the sampling distribution of $m$ that is _left or right -- whichever area is smaller --_ to our sample mean $m$ (black solid line). As you can see in the plot, the smaller area is always on the _other_ side of our sample mean $m$, _relative to the hypothetical value of $\mu$._ Recall that the sampling distribution of $m$  represents a 'number-approaching-infinity' amount of $m$'s, each obtained from a random sample of size $N$. Thus, the area on the _other_ side to our sample mean $m$ tells us how often we would observe an $m$ _at least as far away from $\mu$_ as ours, if we drew 'number-approaching-infinity' samples of size $N$.

That is, the _two_-sided $p$-value for a hypothetical value of $\mu$ means: If $\mu$ were indeed this hypothetical value, we would observe a sample mean $m$ _at least as far away from $\mu$_ as the one we observed in our sample $p \times 100 \%$ of the time -- if we drew 'number-approaching-infinity' samples of size $N$.

The __bottom panel__ shows _two_-sided $p$-values for a range of hypothetical values of $\mu$ (often referred to as a $p$-value curve).

### Interpreting $p$-values (summary)
The $p$-value is a measure of compatibility of a hypothetical value of $\mu$ with our sample data. 

In our working scenario, our sample data is summarized by the sample mean $m$ because we know the sampling distribution of $m$. Thus, the $p$-value answers the question: If $\mu$ were indeed this hypothetical value, how often would we observe a sample mean $m$ that is _at least_ as large (right-sided) / as small (left-sided) / as far away from $\mu$ (two-sided) as the one we observed if we repeated the experiment 'number-approaching-infinity' times? The less often, the less compatible the hypothetical value of $\mu$ is with our sample data.

In our working scenario, the sample data can be summarized by the sample mean $m$ because we know the corresponding sampling distribution $m \sim {\sf Normal}(\mu,\frac{\sigma}{\sqrt{N}})$ under some assumed value for $\mu$ -- as we know $\sigma$. If we didn't, we'd have to summarize our sample data using some other statistic whose sampling distribution we do know under some assumed true value for our parameter of interest. After all, we need the sampling distribution to compute $p$-values. 

In general, our data is summarized by some statistic whose sampling distribution we know. The $p$-value answers the question: If our parameter of interest were indeed this hypothetical value, how often would we observe a statistic that is _at least_ as large (right-sided) / as small (left-sided) / as extreme (two-sided) as the one we observed if we repeated the experiment 'number-approaching-infinity' times? 

### Avoid misinterpreting $p$-values
A common mistake is to say that the $p$-value is the probability that the hypothetical value of $\mu$ is indeed the true value. Let's put aside that this would violate the mathematical laws of probability theory (the probability over all hypothetical values of $\mu$ would not add up to 1 -- in fact, it would be infinite because there are infinitely many hypothetical values for $\mu$, as it is an element of the space of _Real numbers_). The statement immediately raises a red flag: We would be assigning probability to a non-repeatable event, which is inconsistent with the frequentist interpretation of probability!

And if we remember the computational steps, it is clear why the $p$-value is not the probability that the hypothetical value of $\mu$ is indeed the true value: the $p$-value is computed _under the assumption that the hypothetical value of $\mu$ is indeed the true value_.

To drive this point home, consider the following example: You have a big urn filled with red and blue pills -- and you want to know the red/blue ratio. You grab a 10 pills and look at the ratio: it's 7/3 red/blue. How would you obtain a $p$-value for a hypothetical true ratio of 50%/50%, empirically? First, _you fill a separate identical urn with 50%/50% red/blue pills_. Then, you grab 10 pills over and over again (each time putting them back and shaking the urn to mix the pills so your picks are random). The rate at which you get ratios of 7/3 or higher is your right-sided $p$-value. The rate at which you get ratios of 7/3 or lower is your left-sided $p$-value. The minimum of those two (here: the right-sided $p$-value) multiplied by 2 is your two-sided $p$-value. All these $p$-values for a hypothetical ratio of 50%/50% are _based on an urn where the ratio is indeed 50%/50%_. ^[Note: In our working scenario, the shape of the sampling distribution is independent of the true value of $\mu$. In contrast, in the urn-example, the shape of the sampling distribution depends on the true ratio of red/blue. You can plot the sampling distribution using the following `R` code: `plot(0:N/N, dbinom(0:N,N,prop), type="h", xlab="Proportion Red", ylab="Frequency")`. Just set `N` as the number of pills you grab (in our example, `N=10`) and `prop` as the proportion of red pills in the urn (a number between `0` and `1`). If the true ratio is 50%/50% (`prop=0.5`), the distribution will be symmetric. However, if the true proportion is low -- e.g. 90%/10% (`prop=0.9`) -- or high -- e.g. 10%/90% (`prop=0.1`) -- the distribution will be skewed. As `N` increases, this skewness goes away. Can you tell why? Note that for any given value of `N`, the distribution will have the highest variance if `prop=0.5`.]

The probability $p$ does not refer to the hypothetical value of $\mu$ being the true one -- it refers to how often, in the long run, we'd observe $m$ as (small / large / far away from $\mu$ as ours) _if_ the hypothetical value of $\mu$ _were_ the true one.

### Distribution of $p$-values
If we repeatedly draw samples and each time compute the $p$-value for the _same_ hypothetical vlaue of $\mu$, how will those $p$-values be distributed? If the hypothetical value of $\mu$ that we are evaulating is indeed the true value, then $p$-values will be uniformly distributed -- i.e. $p \sim {\sf Uniform}(0,1)$. This means that all $p$-values (between 0 and 1) are equally likely in the long run. 

I will now explain why this is the case using left-sided $p$-values, but the same reasoning also applies to right-sided and two-sided $p$-values. 

```{r punif explained plot, fig.height=1.4, fig.width=5}
set.seed(5)
mu=100; sigma=10; N=15; reps=100000

sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)) #sample 

popdis = with(density(rnorm(reps,0,sigma)), data.frame(x,y)) #popdis centred on zero
samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y)) #samdis centred on zero

pvals = 2*c((1-0.7), 0.3, 0.1); side = c("R","L","L") #don't forget to adjust appropriately if area left or right to sample mean is shaded in plot

p = ggplot(data=samdis, aes(x=x, y=y))+
  geom_area(data=popdis, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  annotate("rect", xmin=-30, xmax=30, ymin=0, ymax=max(samdis$y), color="white", fill="white", alpha=0.5)+
  geom_area(size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=c(-30,30), breaks=seq(-20,20,10), name=expression(paste("Distance from ",mu,"")))+
  scale_y_continuous(name="")+
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.1=p + geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x<qnorm(0.2,0,sigma/sqrt(N)),x,NA))) + geom_vline(xintercept=qnorm(0.2,0,sigma/sqrt(N)))
p.2=p + geom_area(size=1, color=NA, fill="darkred", alpha=0.4, aes(x=ifelse(x<qnorm(0.8,0,sigma/sqrt(N)),x,NA))) + geom_vline(xintercept=qnorm(0.8,0,sigma/sqrt(N)))

p.1 / p.2
```

First, let's be clear about what we are doing: We repeatedly draw samples of size $N$. Each time we compute a left-sided $p$-value for the same hypothetical value of $\mu$. This hypothetical value of $\mu$ is indeed the true value (this is highlighted above by centering the sampling distribution of $m$ at the population mean $\mu$). Each time we draw a sample, we will get a different $m$ (black solid line) and thus a different $p$-value (red area left to the black solid line). Above are two examples which happen to be $p=0.2$ and $p=0.8$.

Now, we ask: How often would we observe a $p$-value at least as small as ours? For that to happen, $m$ must be at least as far left as ours. Thus, the answer is given by the red area left to the black solid line -- which is the $p$-value! We would observe $p \le 0.2$ at a rate of $0.2$ and $p \le 0.8$ at a rate of $0.8$! In general, we would observe $p \le P$ at a rate $P$ and equivalently $P_1 \le p \le P_2$ at a rate $P_2 - P_1$ (e.g. $0.2 \le p \le 0.8$ at a rate of $0.6$). Thus, if the hypothetical value of $\mu$ that we are evaulating is indeed the true value, then $p$-values will be uniformly distributed (and if _not_, then _not_).

# Rejection if $p \le \alpha$
Recall that we reject hypothetical values for $\mu$ if they are incompatible with our sample data. Now we know that we quantify compatibility via the $p$-value, so we can impose a threshold $\alpha$ that defines how low the compatibility has to be for us to reject the hypothetical value for $\mu$. In other words, if $p \le \alpha$, we reject the hypothetical value for $\mu$. 

### Our Rule of Inference
In propositional calculus, this rule of inference is called _modus tollens_. 

Imagine you are looking for me in a group a people. You check every person in that group. However, all you know is that I am always wearing a blue shirt. It goes like this:

1. __If I then B__: If you see me, I'll always be wearing a blue shirt.
2. __Not B__: The person you see is not wearing a blue shirt.
3. __Therefore not I__: The person you see is not me.

+ Note that __you cannot say B therefore I__: Just because you see someone wearing a blue shirt doesn't mean it's me; many people wear blue shirts.

Will you ever make an error -- i.e. you indeed see me, but conclude that you are not? Never -- the method is bulletproof! 

Now consider this slight modification:

1. __If I then B *99% of the time*__: If you see me, I'll be wearing a blue shirt *99% of the time*.
2. __Not B__: The person you see is not wearing a blue shirt.
3. __Therefore not I__: The person you see is not me.

+ Note that __you cannot say B therefore I__: Just because you see someone wearing a blue shirt doesn't mean it's me; many people wear blue shirts.

Will you ever make an error -- i.e. you indeed see me, but conclude that you are not? Yes, 1% of the time -- the method has an error rate of 0.01!

Now let's go back to our working scenario. Instead of rejecting that the person you see is me, we reject that the hypothetical value for $\mu$ is the true value. Instead of using the shirt color you'd expect most of the time _if_ the person was me, we are using the $p$-value or equivalently the sample mean $m$ that we'd expect most of the time _if_ the hypothetical value for $\mu$ was the true value. 

Phrasing it in terms of the $p$-value:

1. If this hypothetical value for $\mu$ were the true value, we would observe $p > \alpha$ with frequency $1-\alpha$ (and $p \le \alpha$ with frequency $\alpha$). (*Because then, $p$-values would be uniformly distributed!*)
2. We did not observe $p > \alpha$ (we observed $p \le \alpha$).
3. Therefore this hypothetical value for $\mu$ is not the true value. We reject it!

+ Note that we _cannot_ say: We did observe $p > \alpha$, therefore this hypothetical value for $\mu$ is the true value. Many hypothetical values for $\mu$ will have $p > \alpha$.

Equivalently, phrasing it in terms of the sample mean $m$: 

1. If this hypothetical value for $\mu$ were the true value, $m$ would fall within a certain range with frequency $1-\alpha$ (and $m$ would fall outside that range with frequency $\alpha$).
2. We did not observe $m$ within that range (we observed $m$ outside that range).
3. Therefore this hypothetical value for $\mu$ is not the true value. We reject it!

+ Note that we _cannot_ say: We did observe $m$ within that range, therefore this hypothetical value for $\mu$ is the true value. $m$ will be within the anticipated range for many hypothetical values of $\mu$. 

Will we ever make an error -- i.e. our hypothetical value for $\mu$ is indeed the true value, yet we reject it? Yes, $\alpha \times 100\%$ of the time -- the method has an error rate of $\alpha$! Note that the aforementioned error is called a _false positive error_. Thus, $\alpha$ is called the _false positive error rate_.  

# Confidence Intervals
So, we reject hypothetical values for $\mu$ if $p \le \alpha$. We can easily compute  an interval of non-rejected values for $\mu$ -- i.e. an interval containing all hypothetical values for $\mu$ for which $p > \alpha$. Such an interval is called a $(1-\alpha) \times 100\%$ _confidence interval_.

In what follows, we bring back our sample of $N=15$ from earlier and compute confidence intervals using the corresponding sampling distribution of $m$. We will use $\alpha = 0.05$, i.e. we will compute 95% confidence intervals. We will compute three types of 95% confidence intervals: based on right-sided, left-sided, and two-sided $p$-values.

### Computing and interpreting the CI based on the right-sided $p$-value
The top two panels show our building blocks for computing the $p$-value (nothing new here). 

```{r rightsided alpha plot, fig.height=5, fig.width=5}
alpha = 0.05
shift = qnorm(alpha,mean(sample$x),sigma/sqrt(N))

samdis$xl = samdis$x + shift # left samdis

shiftup = max(samdis$y)*1.25
samdis$yl = samdis$y + shiftup 

p.sample = p.sample+
  theme(axis.title.x=element_blank())

p.ci = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl, ymin=shiftup*1, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl>mean(sample$x),xl,NA), ymin=shiftup*1, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=mean(sample$x))+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift, xend=shift, y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+
  # CI & Point Estimate
  geom_segment(aes(x=shift, xend=130, y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve = ggplot(data=pcurve.rs, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift, xend=130, y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.ci / p.cipcurve
```

The bottom two panels show how we compute the confidence interval using the right-sided $p$-value, which includes all hypothetical values for $\mu$ for which $p > \alpha$. All we have to do is find the hypothetical values for $\mu$ with $p = \alpha$, which is the boundary. The interval gives us a lower bound for non-rejected values for $\mu$ (and goes up to $\infty$). 

### Computing and interpreting the CI based on the left-sided $p$-value
The top two panels show our building blocks for computing the $p$-value (nothing new here).

```{r leftsided alpha plot, fig.height=5, fig.width=5}
alpha = 0.05
shift = qnorm(1-alpha,mean(sample$x),sigma/sqrt(N))

samdis$xr = samdis$x + shift # left samdis

shiftup = max(samdis$y)*1.25
samdis$yr = samdis$y + shiftup 

p.sample = p.sample+
  theme(axis.title.x=element_blank())

p.ci = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xr, ymin=shiftup*1, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr<mean(sample$x),xr,NA), ymin=shiftup*1, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=mean(sample$x))+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift, xend=shift, y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+
  # CI & Point Estimate
  geom_segment(aes(x=shift, xend=70, y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve = ggplot(data=pcurve.ls, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift, xend=70, y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.ci / p.cipcurve
```

The bottom two panels show how we compute the confidence interval using the right-sided $p$-value, which includes all hypothetical values for $\mu$ for which $p > \alpha$. All we have to do is find the hypothetical value for $\mu$ with $p = \alpha$, which is the boundary. The interval gives us an upper bound for non-rejected values for $\mu$ (and goes down to $-\infty$). 

### Computing and interpreting the CI based on the two-sided $p$-value
The top two panels show our building blocks for computing the $p$-value (nothing new here).

```{r twosided alpha plot, fig.height=5.5, fig.width=5}
alpha = 0.05
shift = qnorm(c(alpha/2, 1-alpha/2),mean(sample$x),sigma/sqrt(N))

samdis$xl = samdis$x + shift[1] # left samdis
samdis$xr = samdis$x + shift[2] # right samdis

shiftup = max(samdis$y)*1.25
samdis$yl = samdis$y + shiftup*2 # CI, right samdis, left samdis are spaced 1.25 * (height of samdis) on y
samdis$yr = samdis$y + shiftup   # ... i.e. the two samdis are spaced 0.25 * (height of samdis) on y

p.sample = p.sample+
  theme(axis.title.x=element_blank())

p.ci = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl, ymin=shiftup*2, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl>mean(sample$x),xl,NA), ymin=shiftup*2, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Right sampling distribution and area
  geom_ribbon(aes(x=xr, ymin=shiftup, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr<mean(sample$x),xr,NA), ymin=shiftup, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=mean(sample$x))+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift[1], xend=shift[1], y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #left
  geom_segment(aes(x=shift[2], xend=shift[2], y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #right
  # CI & Point Estimate
  geom_segment(aes(x=shift[1], xend=shift[2], y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05 .... ",frac(alpha,2),"  =  0.025  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  annotate("rect", size=1, color="darkred", fill="darkred", alpha=0.4, xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(".... ",frac(alpha,2),"  =  0.025  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve = ggplot(data=pcurve.2s, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift[1], xend=shift[2], y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=mean(sample$x), y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.pop / p.sample / p.ci / p.cipcurve
```

The bottom two panels show how we compute the confidence interval using the right-sided $p$-value, which includes all hypothetical values for $\mu$ for which $p > \alpha$. All we have to do is find the hypothetical values for $\mu$ with $p = \alpha$, which are the boundaries. The interval gives us a lower and an upper bound for non-rejected values for $\mu$.

### Interpreting the CI
The $(1-\alpha) \times 100\%$ confidence interval includes all hypothetical values of $\mu$ for which $p>\alpha$, and excludes all values for which $p\le\alpha$. Hence, the $(1-\alpha) \times 100\%$ confidence interval covers the true value of $\mu$ $\alpha\times100\%$ of the time in the long-run.

### Avoid misinterpreting the CI
A common mistake is to say that any _specific_ confidence interval _you calculated_ -- e.g. the one in the plot above -- covers the true value of $\mu$ with probability $1-\alpha$. Once again, this statement raises a red flag from earlier: We would be assigning probability to a non-repeatable event, which would be inconsistent with the frequentist interpretation of probability! The key part of the above statement is "$\mu$ lies within this interval, which is just as non-repeatable as "time-travel is possible". 

The correct statement is that confidence intervals will cover the true value of $\mu$ at a rate $1-\alpha$, in the long-run. This does _not_ mean there is a $1-\alpha$ probability that our _specific_ confidence interval covers the true value of $\mu$. 

When I first learned about this I was surprised, because intuitively it felt like the second statement follows from the first. It does not! But I think the reason it felt that way was that in everyday language, we use the word 'probability' loosely without qualifying what it acutally refers to. I know that if I flip a coin over and over again, I will get heads and tails 50% of the time each. So intuitively, if you flipped a coin and I were to predict the outcome, I would put equal credences on heads and tails. These are two different statements: one about long-run frequencies, the other about personal belief. Yet both are saying that getting heads and tails have equal probability, which makes it feel like they go hand in hand.

To really drive this point home, consider the following example. We go back to our working scenario where we are after $\mu$, but we use a different method to obtain our interval: we roll three dice, if all three show the same number the interval is empty (~ 3% of the time), if not the interval goes from $-\infty$ to $+\infty$. This is a ~97% confidence interval in the sense that it will cover $\mu$ ~97% of the time in the long-run. Yet you would never even think about saying that any _specific_ interval has a 97% probability of covering $\mu$ -- if it's infinite it clearly does, and if it's empty it clearly doesn't. The 97% are really a statement about the method of obtaining intervals (and its stable long-run performance), not about any particular interval itself (and the data you happened to get).

Note that another common mistake is to say that the confidence interval includes a range of 'plausible' values for $\mu$. This is pretty much the same fallacy as discussed above ('plausible' means the same as 'probable'), just without attaching a number to it.

To sum up, $1-\alpha$ is not the probability that any specific confidence interval covers the true value of $\mu$ -- it is the rate at which confidence intervals cover the true value of $\mu$ in the long-run.

```{r overview plot hyptesting, fig.height=2.5, fig.width=5}
set.seed(4)

P = with(density(rnorm(50000, mean=-100, sd=20)), data.frame(x,y))
S = data.frame(x=rnorm(n=15, mean=100, sd=20), y=rep(0, 15))
m = mean(S$x)

ggplot()+
  # Population
  geom_area(data=P, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_segment(aes(x=-100, xend=-100, y=-.002, yend=0.02), size=1, color="navy", linetype="dashed")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=-100, y=-0.003, label="mu", color="navy")+
  # Sample
  geom_point(data=S, aes(x=x, y=y), shape=21, size=3, stroke=1.5, color="black", fill="gray85", position=position_jitter(h=0.002))+
  # CI
  geom_segment(aes(x=-120, xend=-90, y=-0.015, yend=-0.015), size=1.5, color="darkred")+
  # Arrows
  geom_curve(aes(x=-50, xend=50, y=0.015, yend=0.01), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  geom_curve(aes(x=50, xend=-50, y=-0.01, yend=-0.015), size=1, arrow=arrow(length=unit(0.2, "cm")), curvature=-0.1, ncp=10)+
  # Text 
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=0.025, label="'Task: Can we reject that '~mu==mu[0]~'?'", color="navy")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.016, label="'Result: Interval'", color="darkred")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.021, label="'of'~bold('non-rejected values')~'for '~mu~'.'", color="darkred")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-200, y=-0.026, label="'If '~mu[0]~' is outside the interval, reject it.'", color="darkred")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.010, label="~mu~' (mean)'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-185, y=0.005, label="~sigma~' (stdev)'")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=65, y=0.010, label="~m~' (mean)'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=65, y=0.005, label="~s~'  (stdev)'")+
  
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=+0.017, label="'Draw sample of size N.'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.022, label="'Narrow down '~mu~' by'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.026, label="bold('rejecting values')~'which are'")+
  annotate(geom="text", size=3, hjust=0, vjust=0, parse=T, x=-50, y=-0.030, label="bold('incompatible')~'with the sample data.'")+
  
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=-100, y=0.035, label="'POPULATION'")+
  annotate(geom="text", size=4, hjust=0.5, vjust=0, parse=T, x=80, y=0.035, label="'RANDOM SAMPLE'")+
  # Dotted Line
  geom_segment(aes(x=0, xend=0, y=0.04, yend=0.022), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=0.012, yend=-0.012), size=0.5, linetype="dotted")+
  geom_segment(aes(x=0, xend=0, y=-0.033, yend=-0.04), size=0.5, linetype="dotted")+
  # x-axis population
  geom_segment(aes(x=-150, xend=-50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(-140,-60,10), xend=seq(-140,-60,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=-100, y=-0.035-0.002)+
  # x-axis sample
  geom_segment(aes(x=m-50, xend=m+50, y=-0.035, yend=-0.035))+
  geom_segment(aes(x=seq(m-40,m+40,10), xend=seq(m-40,m+40,10), y=-0.035-0.001, yend=-0.035+0.001))+
  annotate("text", hjust=0.5, vjust=1, size=3, label="X", x=m, y=-0.035-0.002)+
  # Design
  scale_y_continuous(limits=c(-0.04,0.04), name="")+
  scale_x_continuous(limits=c(-200,150))+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank())

```


```{r rightsided beta plot, fig.height=7.5, fig.width=5}
h0 = 100
alpha = 0.05
beta  = c(0.7, 0.3, 0.05)

x.reject = h0 + abs(qnorm(alpha,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection
#x.valofi = x.reject[2] +  abs(qnorm(beta,0,1))*sigma/sqrt(N)  #value of interest (with 1-beta power)

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)

for(i in 1:length(beta)){
  
  if(beta[i] <= 0.5){
    x.valofi[i] = x.reject + abs(qnorm(beta[i],0,1))*sigma/sqrt(N)
  }else{
    x.valofi[i] = x.reject - abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)
  }
}

#samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi[1]
samdis$x2 = samdis$x + x.valofi[2]
samdis$x3 = samdis$x + x.valofi[3]

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*3
samdis$y1 = samdis$y + shiftup*2
samdis$y2 = samdis$y + shiftup*1
samdis$y3 = samdis$y

  
p.beta = ggplot(data=samdis)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*3), color="darkred", fill="white", size=1, alpha=1)+
  ##geom_ribbon(aes(x=ifelse(x0<x.reject,x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject,x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject,x1,NA), ymax=y1, ymin=shiftup*2), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2<x.reject,x2,NA), ymax=y2, ymin=shiftup*1), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis$y2), yend=-.05))+
  # 4th Layer
  geom_ribbon(aes(x=x3, ymax=y3, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x3<x.reject,x3,NA), ymax=y3, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[3], xend=x.valofi[3], y=max(samdis$y3), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(mu[2]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  annotate("text", label=expression(mu[3]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[3], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=3*shiftup+0.06, ymax=3*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=3*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[1]," ....")), hjust=0, vjust=0.5, x=70, y=2*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.70  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[2]," ....")), hjust=0, vjust=0.5, x=70, y=1*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.30  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[3]," ....")), hjust=0, vjust=0.5, x=70, y=0*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu<=100," (i.e. ",mu[0],"),  ","H1: ",mu>100," (e.g. ",mu[1],", ",mu[2],", ",mu[3],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(title=element_text(size=7),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

x = seq(70,130,0.1)
b = vector(length=length(x))

for(i in 1:length(x)){
  b[i] = pnorm(x.reject, x[i], sigma/sqrt(N))
}

betacurve = data.frame(x, b)
powacurve = data.frame(x, pow=1-b)

p.betacurve = ggplot(betacurve, aes(x=x, y=b))+
  # beta curve
  geom_line(size=1, color="dodgerblue", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=1-alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=beta[1], yend=beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=beta[2], yend=beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=beta[3], yend=beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(1-alpha,"  =  0.95")), hjust=0, vjust=1, x=70, y=1-alpha-0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Non-Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(beta,"   or   ",1-alpha)))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.powercurve = ggplot(powacurve, aes(x=x, y=pow))+
  # power curve
  geom_line(size=1, color="black", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=1-beta[1], yend=1-beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=1-beta[2], yend=1-beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=1-beta[3], yend=1-beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(1-beta,"   or   ",alpha)))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.pop / p.beta / p.betacurve / p.powercurve
```


```{r leftsided beta plot, fig.height=7.5, fig.width=5}
h0 = 100
alpha = 0.05
beta  = c(0.7, 0.3, 0.05)

x.reject = h0 - abs(qnorm(alpha,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection
#x.valofi = x.reject[2] +  abs(qnorm(beta,0,1))*sigma/sqrt(N)  #value of interest (with 1-beta power)

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)

for(i in 1:length(beta)){
  
  if(beta[i] <= 0.5){
    x.valofi[i] = x.reject - abs(qnorm(beta[i],0,1))*sigma/sqrt(N)
  }else{
    x.valofi[i] = x.reject + abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)
  }
}

#samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi[1]
samdis$x2 = samdis$x + x.valofi[2]
samdis$x3 = samdis$x + x.valofi[3]

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*3
samdis$y1 = samdis$y + shiftup*2
samdis$y2 = samdis$y + shiftup*1
samdis$y3 = samdis$y

  
p.beta = ggplot(data=samdis)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*3), color="darkred", fill="white", size=1, alpha=1)+
  ##geom_ribbon(aes(x=ifelse(x0<x.reject,x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0<x.reject,x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1>x.reject,x1,NA), ymax=y1, ymin=shiftup*2), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2>x.reject,x2,NA), ymax=y2, ymin=shiftup*1), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis$y2), yend=-.05))+
  # 4th Layer
  geom_ribbon(aes(x=x3, ymax=y3, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x3>x.reject,x3,NA), ymax=y3, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[3], xend=x.valofi[3], y=max(samdis$y3), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(mu[2]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  annotate("text", label=expression(mu[3]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[3], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=3*shiftup+0.06, ymax=3*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=3*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[1]," ....")), hjust=0, vjust=0.5, x=70, y=2*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.70  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[2]," ....")), hjust=0, vjust=0.5, x=70, y=1*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.30  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[3]," ....")), hjust=0, vjust=0.5, x=70, y=0*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu>=100," (i.e. ",mu[0],"),  ","H1: ",mu<100," (e.g. ",mu[1],", ",mu[2],", ",mu[3],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(title=element_text(size=7),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

x = seq(70,130,0.1)
b = vector(length=length(x))

for(i in 1:length(x)){
  b[i] = pnorm(-x.reject, -x[i], sigma/sqrt(N))
}

betacurve = data.frame(x, b)
powacurve = data.frame(x, pow=1-b)

p.betacurve = ggplot(betacurve, aes(x=x, y=b))+
  # beta curve
  geom_line(size=1, color="dodgerblue", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=1-alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=beta[1], yend=beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=beta[2], yend=beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=beta[3], yend=beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(1-alpha,"  =  0.95")), hjust=0, vjust=1, x=70, y=1-alpha-0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Non-Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(beta,"   or   ",1-alpha)))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.powercurve = ggplot(powacurve, aes(x=x, y=pow))+
  # power curve
  geom_line(size=1, color="black", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=1-beta[1], yend=1-beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=1-beta[2], yend=1-beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=1-beta[3], yend=1-beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(1-beta,"   or   ",alpha)))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.pop / p.beta / p.betacurve / p.powercurve
```


```{r twosided beta plot, fig.height=7.5, fig.width=5}
h0 = 100
alpha = 0.05
beta  = c(0.7, 0.3, 0.05)

x.reject = h0 + c(-1,1) * abs(qnorm(alpha/2,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection
#x.valofi = x.reject[2] +  abs(qnorm(beta,0,1))*sigma/sqrt(N)  #value of interest (with 1-beta power)

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)
side = c(1,0,1) #0 for left side, 1 for right side


for(i in 1:length(beta)){
  
  if(side[i]==1){
    
    if(beta[i] <= 0.5){
    x.valofi[i] = x.reject[2] + abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
    
    else{
    x.valofi[i] = x.reject[2] - abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}
  
  else if (side[i]==0){
    
    if(beta[i] <= 0.5){
    x.valofi[i] = x.reject[1] - abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
    
    else{
    x.valofi[i] = x.reject[1] + abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}}
  

samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi[1]
samdis$x2 = samdis$x + x.valofi[2]
samdis$x3 = samdis$x + x.valofi[3]

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*3
samdis$y1 = samdis$y + shiftup*2
samdis$y2 = samdis$y + shiftup*1
samdis$y3 = samdis$y

  
p.beta = ggplot(data=samdis)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*3), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject[1],x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject[2],x0,NA), ymax=y0, ymin=shiftup*3), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1>x.reject[1] & x1<x.reject[2],x1,NA), ymax=y1, ymin=shiftup*2), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2>x.reject[1] & x2<x.reject[2],x2,NA), ymax=y2, ymin=shiftup*1), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis$y2), yend=-.05))+
  # 4th Layer
  geom_ribbon(aes(x=x3, ymax=y3, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x3>x.reject[1] & x3<x.reject[2],x3,NA), ymax=y3, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[3], xend=x.valofi[3], y=max(samdis$y3), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(mu[2]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  annotate("text", label=expression(mu[3]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[3], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=3*shiftup+0.06, ymax=3*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=3*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[1]," ....")), hjust=0, vjust=0.5, x=70, y=2*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.70  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[2]," ....")), hjust=0, vjust=0.5, x=70, y=1*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.30  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste("If ",mu," = ",mu[3]," ....")), hjust=0, vjust=0.5, x=70, y=0*shiftup+0.08)+
  annotate("text", size=3, label=expression(paste(".... ",beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu==100," (i.e. ",mu[0],"),  ","H1: ",mu!=100," (e.g. ",mu[1],", ",mu[2],", ",mu[3],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(title=element_text(size=7),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

x = seq(70,130,0.1)
b = vector(length=length(x))

for(i in 1:length(x)){
  
  if(x[i] >= h0){
    auc.upper = pnorm(x.reject[2], x[i], sigma/sqrt(N))
    auc.lower = pnorm(x.reject[1], x[i], sigma/sqrt(N))
    b[i] = auc.upper - auc.lower
  }else{
    auc.upper = pnorm(-x.reject[2], -x[i], sigma/sqrt(N))
    auc.lower = pnorm(-x.reject[1], -x[i], sigma/sqrt(N))
    b[i] = auc.lower - auc.upper
  }
}

betacurve = data.frame(x, b)
powacurve = data.frame(x, pow=1-b)

p.betacurve = ggplot(betacurve, aes(x=x, y=b))+
  # beta curve
  geom_line(size=1, color="dodgerblue", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=1-alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=beta[1], yend=beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=beta[2], yend=beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=beta[3], yend=beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(1-alpha,"  =  0.95")), hjust=0, vjust=1, x=70, y=1-alpha-0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Non-Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(beta,"   or   ",1-alpha)))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.powercurve = ggplot(powacurve, aes(x=x, y=pow))+
  # power curve
  geom_line(size=1, color="black", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha)+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=1-beta[1], yend=1-beta[1]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=1-beta[2], yend=1-beta[2]), color="black")+
  geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[3], xend=70, y=1-beta[3], yend=1-beta[3]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(1-beta,"   or   ",alpha)))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.pop / p.beta / p.betacurve / p.powercurve
```


```{r rightsided inference plot, fig.height=4.2, fig.width=5}
h0 = 100
alpha = 0.05
beta  = alpha

x.reject = h0 + abs(qnorm(alpha,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)

for(i in 1:length(beta)){
  
  if(beta[i] <= 0.5){
    x.valofi[i] = x.reject + abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
  else{
    x.valofi[i] = x.reject - abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}


#samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*1
samdis$y1 = samdis$y
  
p.beta = ggplot(data=samdis)+
  # H0
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0>x.reject,x0,NA), ymax=y0, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # H1
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject,x1,NA), ymax=y1, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi, y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu<=100," (i.e. ",mu[0],"),  ","H1: ",mu>100," (e.g. ",mu[1],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(plot.title=element_text(size=8),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

pe <- function(p){x=abs(qnorm(p,0,1))*(10/sqrt(15)); return(x)}

scenarios = data.frame(x = c(pe(0.02),pe(0.15))+h0,
                       y = rep(0,2),
                       s = c("A","B"))

p.1 = scenarios %>% filter(s=="A") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=124, y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(A)))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.02))

p.2 = scenarios %>% filter(s=="B") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=124, y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(B)))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.15))

p.pop / p.beta / p.1 / p.2
```


```{r leftsided inference plot, fig.height=4.2, fig.width=5}
h0 = 100
alpha = 0.05
beta  = alpha

x.reject = h0 - abs(qnorm(alpha,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)

for(i in 1:length(beta)){
  
  if(beta[i] <= 0.5){
    x.valofi[i] = x.reject - abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
  else{
    x.valofi[i] = x.reject + abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}


#samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*1
samdis$y1 = samdis$y
  
p.beta = ggplot(data=samdis)+
  # H0
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject,x0,NA), ymax=y0, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # H1
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1>x.reject,x1,NA), ymax=y1, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi, y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu>=100," (i.e. ",mu[0],"),  ","H1: ",mu<100," (e.g. ",mu[1],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(plot.title=element_text(size=8),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

pe <- function(p){x=abs(qnorm(p,0,1))*(10/sqrt(15)); return(x)}

scenarios = data.frame(x = c(-pe(0.02),-pe(0.15))+h0,
                       y = rep(0,2),
                       s = c("A","B"))

p.1 = scenarios %>% filter(s=="A") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x+pe(alpha), xend=72, y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(A)))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.02))

p.2 = scenarios %>% filter(s=="B") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x+pe(alpha), xend=72, y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(B)))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.15))

p.pop / p.beta / p.1 / p.2
```


```{r twosided inference plot, fig.height=5, fig.width=5}
h0 = 100
alpha = 0.05
beta  = rep(alpha,2)

x.reject = h0 + c(-1,1) * abs(qnorm(alpha/2,0,1))*sigma/sqrt(N) #values that would lead to h0 rejection

x.valofi = vector(length=length(beta)) #value of interest (with 1-beta power)
side = c(0,1) #0 for left side, 1 for right side


for(i in 1:length(beta)){
  
  if(side[i]==1){
    
    if(beta[i] <= 0.5){
    x.valofi[i] = x.reject[2] + abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
    else{
    x.valofi[i] = x.reject[2] - abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}
  
  else if (side[i]==0){
    
    if(beta[i] <= 0.5){
    x.valofi[i] = x.reject[1] - abs(qnorm(beta[i],0,1))*sigma/sqrt(N)}
    else{
    x.valofi[i] = x.reject[1] + abs(qnorm(1-beta[i],0,1))*sigma/sqrt(N)}}}
  

samdis = with(density(rnorm(reps,0,sigma/sqrt(N))), data.frame(x,y))
samdis = data.frame(x=samdis$x, y=samdis$y)
samdis$x0 = samdis$x + h0
samdis$x1 = samdis$x + x.valofi[1]
samdis$x2 = samdis$x + x.valofi[2]

shiftup = max(samdis$y)*1.25
samdis$y0 = samdis$y + shiftup*1
samdis$y1 = samdis$y
samdis$y2 = samdis$y

  
p.beta = ggplot(data=samdis)+
  # H0
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject[1],x0,NA), ymax=y0, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject[2],x0,NA), ymax=y0, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis$y0), yend=-.05))+
  # H1 w/ low beta left
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1>x.reject[1] & x1<x.reject[2],x1,NA), ymax=y1, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis$y1), yend=-.05))+
  # H1 w/ low beta right
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2>x.reject[1] & x2<x.reject[2],x2,NA), ymax=y2, ymin=shiftup*0), color=NA, fill="dodgerblue", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis$y2), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(mu[0]), size=4, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(mu[1]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(mu[2]), size=4, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="dodgerblue", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(beta,"  =  0.05  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  
  ggtitle(expression(paste("H0: ",mu==100," (i.e. ",mu[0],"),  ","H1: ",mu!=100," (e.g. ",mu[1],", ",mu[2],")")))+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(plot.title=element_text(size=8),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$y0)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

pe <- function(p){x=abs(qnorm(p/2,0,1))*(10/sqrt(15)); return(x)}

scenarios = data.frame(x = c(pe(0.02),-pe(0.04),pe(0.15),-pe(0.06))+h0,
                       y = rep(0,4),
                       s = c("A1","A2","B1","B2"))

p.1 = scenarios %>% filter(s=="A1") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=x+pe(alpha), y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(A[1])))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.02))

p.2 = scenarios %>% filter(s=="A2") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=x+pe(alpha), y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(A[2])))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.04))

p.3 = scenarios %>% filter(s=="B1") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=x+pe(alpha), y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(B[1])))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.15))

p.4 = scenarios %>% filter(s=="B2") %>%
  ggplot(aes(x=x, y=y))+
  geom_vline(xintercept=x.reject, size=0.5, color="black")+
  geom_vline(xintercept=h0, size=0.5, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, size=0.5, color="navy", linetype="dashed")+
  geom_segment(aes(x=x-pe(alpha), xend=x+pe(alpha), y=y, yend=y), color="darkred", size=1.5)+
  geom_point(size=4, shape=22, color="darkred", fill="darkred")+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-1,1))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.title.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        aspect.ratio=0.05)+
  annotate("text", size=4, hjust=0, vjust=0.5, x=70, y=0, label=expression(bold(B[2])))+
  annotate("text", size=3, hjust=1, vjust=0.5, x=130, y=0, label=expression(p==0.06))

p.pop / p.beta / p.1 / p.2 / p.3 / p.4
```


```{r power vs N, fig.height=5.7, fig.width=5}
h0 = 100; x = seq(70,130,0.1); b1 = vector(length=length(x)); b2=b1; x.valofi = c(107,112)

N = c(5,15)
alpha = c(0.05,0.05)
sigma = c(10,10)

# Values that would lead to h0 rejection.
x.reject1 = h0 + c(-1,1) * abs(qnorm(alpha[1]/2,0,1))*sigma[1]/sqrt(N[1])
x.reject2 = h0 + c(-1,1) * abs(qnorm(alpha[2]/2,0,1))*sigma[2]/sqrt(N[2])

# Power.
for(i in 1:length(x)){
  
  if(x[i] >= h0){
    auc.upper1 = pnorm(x.reject1[2], x[i], sigma/sqrt(N[1]))
    auc.lower1 = pnorm(x.reject1[1], x[i], sigma/sqrt(N[1]))
    b1[i] = auc.upper1 - auc.lower1
    auc.upper2 = pnorm(x.reject2[2], x[i], sigma/sqrt(N[2]))
    auc.lower2 = pnorm(x.reject2[1], x[i], sigma/sqrt(N[2]))
    b2[i] = auc.upper2 - auc.lower2
  }else{
    auc.upper1 = pnorm(-x.reject1[2], -x[i], sigma/sqrt(N[1]))
    auc.lower1 = pnorm(-x.reject1[1], -x[i], sigma/sqrt(N[1]))
    b1[i] = auc.lower1 - auc.upper1
    auc.upper2 = pnorm(-x.reject2[2], -x[i], sigma/sqrt(N[2]))
    auc.lower2 = pnorm(-x.reject2[1], -x[i], sigma/sqrt(N[2]))
    b2[i] = auc.lower2 - auc.upper2}}

powacurve = data.frame(x, pow1=1-b1, pow2=1-b2)

# Power for values of interest.
power1    = powacurve$pow1[powacurve$x==x.valofi[1]]
power1[2] = powacurve$pow1[powacurve$x==x.valofi[2]]
power2    = powacurve$pow2[powacurve$x==x.valofi[1]]
power2[2] = powacurve$pow2[powacurve$x==x.valofi[2]]

# Sampling distributions over h0 and values of interest.
samdis1 = with(density(rnorm(reps,0,sigma[1]/sqrt(N[1]))), data.frame(x,y))
samdis2 = with(density(rnorm(reps,0,sigma[2]/sqrt(N[2]))), data.frame(x,y))
samdis1 = samdis1 %>%
  mutate(x0=x+h0, x1=x+x.valofi[1], x2=x+x.valofi[2])
samdis2 = samdis2 %>%
  mutate(x0=x+h0, x1=x+x.valofi[1], x2=x+x.valofi[2])

# Vertical shift for sampling distributions. 
shiftup = max(c(samdis1$y,samdis2$y))*1.25
samdis1 = samdis1 %>%
  mutate(y0=y+shiftup*2, y1=y+shiftup*1, y2=y)
samdis2 = samdis2 %>%
  mutate(y0=y+shiftup*2, y1=y+shiftup*1, y2=y)


p.dists1 = ggplot(data=samdis1)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*2), color="purple4", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject1[1],x0,0), ymax=y0, ymin=shiftup*2), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject1[2],x0,0), ymax=y0, ymin=shiftup*2), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis1$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*1), color="purple4", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject1[1],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x1>x.reject1[2],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis1$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*0), color="purple4", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2<x.reject1[1],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x2>x.reject1[2],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="purple4", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis1$y2), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject1, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(100), size=3, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(107), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(112), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="purple4", fill="purple4", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="purple4", fill="purple4", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="purple4", fill="purple4", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,max(samdis2$y0)), name="")+
  # design
  theme_bw()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis1$y0)/max(samdis2$y)*0.1)+ 
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.14, label=expression(paste("H0: ",mu==100,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.07, label=expression(paste(sigma==10,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.00, label=expression(paste(alpha==0.05)), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=-0.07, label=expression(paste(N==5)), color="black")

p.dists2 = ggplot(data=samdis2)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject2[1],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject2[2],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis2$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject2[1],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x1>x.reject2[2],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis2$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2<x.reject2[1],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x2>x.reject2[2],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis2$y2), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject2, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(100), size=3, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(107), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(112), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,max(samdis2$y0)), name="")+
  # design
  theme_bw()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis2$y0)/max(samdis2$y)*0.1)+ 
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.14, label=expression(paste("H0: ",mu==100,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.07, label=expression(paste(sigma==10,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.00, label=expression(paste(alpha==0.05)), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=-0.07, label=expression(paste(N==15)), color="black")

p.powercurve = ggplot(powacurve)+
  # power curve
  geom_line(aes(x=x, y=pow1), size=1, color="purple4", alpha=0.8)+
  geom_line(aes(x=x, y=pow2), size=1, color="darkred", alpha=0.8)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha)+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=power1[1], yend=power1[1]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=power1[2], yend=power1[2]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=power2[1], yend=power2[1]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=power2[2], yend=power2[2]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(1-beta,"   or   ",alpha)))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.dists1 / p.dists2 / p.powercurve
```


```{r power vs alpha, fig.height=5.8, fig.width=5}
h0 = 100; x = seq(70,130,0.1); b1 = vector(length=length(x)); b2=b1; x.valofi = c(107,112)

N = c(15,15)
alpha = c(0.05,0.20)
sigma = c(10,10)

# Values that would lead to h0 rejection.
x.reject1 = h0 + c(-1,1) * abs(qnorm(alpha[1]/2,0,1))*sigma[1]/sqrt(N[1])
x.reject2 = h0 + c(-1,1) * abs(qnorm(alpha[2]/2,0,1))*sigma[2]/sqrt(N[2])

# Power.
for(i in 1:length(x)){
  
  if(x[i] >= h0){
    auc.upper1 = pnorm(x.reject1[2], x[i], sigma/sqrt(N[1]))
    auc.lower1 = pnorm(x.reject1[1], x[i], sigma/sqrt(N[1]))
    b1[i] = auc.upper1 - auc.lower1
    auc.upper2 = pnorm(x.reject2[2], x[i], sigma/sqrt(N[2]))
    auc.lower2 = pnorm(x.reject2[1], x[i], sigma/sqrt(N[2]))
    b2[i] = auc.upper2 - auc.lower2
  }else{
    auc.upper1 = pnorm(-x.reject1[2], -x[i], sigma/sqrt(N[1]))
    auc.lower1 = pnorm(-x.reject1[1], -x[i], sigma/sqrt(N[1]))
    b1[i] = auc.lower1 - auc.upper1
    auc.upper2 = pnorm(-x.reject2[2], -x[i], sigma/sqrt(N[2]))
    auc.lower2 = pnorm(-x.reject2[1], -x[i], sigma/sqrt(N[2]))
    b2[i] = auc.lower2 - auc.upper2}}

powacurve = data.frame(x, pow1=1-b1, pow2=1-b2)

# Power for values of interest.
power1    = powacurve$pow1[powacurve$x==x.valofi[1]]
power1[2] = powacurve$pow1[powacurve$x==x.valofi[2]]
power2    = powacurve$pow2[powacurve$x==x.valofi[1]]
power2[2] = powacurve$pow2[powacurve$x==x.valofi[2]]

# Sampling distributions over h0 and values of interest.
samdis1 = with(density(rnorm(reps,0,sigma[1]/sqrt(N[1]))), data.frame(x,y))
samdis2 = with(density(rnorm(reps,0,sigma[2]/sqrt(N[2]))), data.frame(x,y))
samdis1 = samdis1 %>%
  mutate(x0=x+h0, x1=x+x.valofi[1], x2=x+x.valofi[2])
samdis2 = samdis2 %>%
  mutate(x0=x+h0, x1=x+x.valofi[1], x2=x+x.valofi[2])

# Vertical shift for sampling distributions. 
shiftup = max(c(samdis1$y,samdis2$y))*1.25
samdis1 = samdis1 %>%
  mutate(y0=y+shiftup*2, y1=y+shiftup*1, y2=y)
samdis2 = samdis2 %>%
  mutate(y0=y+shiftup*2, y1=y+shiftup*1, y2=y)


p.dists1 = ggplot(data=samdis1)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject1[1],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject1[2],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis1$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject1[1],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x1>x.reject1[2],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis1$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2<x.reject1[1],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x2>x.reject1[2],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis1$y2), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject1, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(100), size=3, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(107), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(112), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,NA), name="")+
  # design
  theme_bw()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis1$y0)/max(samdis2$y)*0.1)+ 
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.14, label=expression(paste("H0: ",mu==100,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.07, label=expression(paste(sigma==10,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.00, label=expression(paste(alpha==0.05)), color="black")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=-0.07, label=expression(paste(N==15)), color="#3b3b3b")

p.dists2 = ggplot(data=samdis2)+
  # Top Layer
  geom_ribbon(aes(x=x0, ymax=y0, ymin=shiftup*2), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x0<x.reject2[1],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x0>x.reject2[2],x0,NA), ymax=y0, ymin=shiftup*2), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="red", linetype="dashed", aes(x=h0, xend=h0, y=max(samdis2$y0), yend=-.05))+
  # 2nd Layer
  geom_ribbon(aes(x=x1, ymax=y1, ymin=shiftup*1), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x1<x.reject2[1],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x1>x.reject2[2],x1,0), ymax=y1, ymin=shiftup*1), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[1], xend=x.valofi[1], y=max(samdis2$y1), yend=-.05))+
  # 3rd Layer
  geom_ribbon(aes(x=x2, ymax=y2, ymin=shiftup*0), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(x2<x.reject2[1],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_ribbon(aes(x=ifelse(x2>x.reject2[2],x2,0), ymax=y2, ymin=shiftup*0), color=NA, fill="darkred", size=1, alpha=0.4)+
  geom_segment(size=0.5, color="navy", linetype="dashed", aes(x=x.valofi[2], xend=x.valofi[2], y=max(samdis2$y2), yend=-.05))+
  # rejection  cutoffs
  geom_vline(xintercept=x.reject2, size=0.5, color="black")+
  # mu annotations
  annotate("text", label=expression(100), size=3, color="red", hjust=0.5, vjust=1, x=h0, y=-.05)+
  annotate("text", label=expression(107), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[1], y=-.05)+
  annotate("text", label=expression(112), size=3, color="navy", hjust=0.5, vjust=1, x=x.valofi[2], y=-.05)+
  # legend
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=2*shiftup+0.06, ymax=2*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(alpha,"  =   ")), hjust=1, vjust=0.5, x=128, y=2*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=1*shiftup+0.06, ymax=1*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=1*shiftup+0.08)+
  
  annotate("rect", size=1, alpha=0.4, color="darkred", fill="darkred", xmin=128, xmax=130, ymin=0*shiftup+0.06, ymax=0*shiftup+0.10)+
  annotate("text", size=3, label=expression(paste(1-beta,"  =   ")), hjust=1, vjust=0.5, x=128, y=0*shiftup+0.08)+
  # axes
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(-.08,max(samdis2$y0)), name="")+
  # design
  theme_bw()+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis2$y0)/max(samdis2$y)*0.1)+ 
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.14, label=expression(paste("H0: ",mu==100,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.07, label=expression(paste(sigma==10,"cm")), color="#3b3b3b")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=+0.00, label=expression(paste(alpha==0.2)), color="black")+
  annotate("text", hjust=0, vjust=0, size=3, x=70, y=-0.07, label=expression(paste(N==15)), color="#3b3b3b")

p.powercurve = ggplot(powacurve)+
  # power curve
  geom_line(aes(x=x, y=pow1), size=1, color="darkred", alpha=0.8)+
  geom_line(aes(x=x, y=pow2), size=1, color="darkred", alpha=0.8)+
  # Highlights
  geom_vline(xintercept=h0, color="red", linetype="dashed")+
  geom_vline(xintercept=x.valofi, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha)+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=power1[1], yend=power1[1]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=power1[2], yend=power1[2]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[1], xend=70, y=power2[1], yend=power2[1]), color="black")+
  #geom_segment(arrow=arrow(length=unit(0.2,"cm")), aes(x=x.valofi[2], xend=70, y=power2[2], yend=power2[2]), color="black")+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=70, y=alpha[1]+0.04)+
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.20")), hjust=0, vjust=0, x=70, y=alpha[2]+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste("H0 Rejection Rate")))+
  #scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.1), name=expression(paste(1-beta,"   or   ",alpha)))+
  theme(panel.grid=element_blank(),
        #axis.title.x=element_blank(),
        aspect.ratio=1/3)

p.dists1 / p.dists2 / p.powercurve
```


```{r power contour, fig.height=2.5, fig.width=6.5}
# Plot 1 ####
h0 = 100; alpha = 0.05; sigma = 10

x_range = seq(85,115,0.1)
n_range = seq(5,55,1)

power = matrix(nrow=length(n_range), ncol=length(x_range))

# Values that would lead to h0 rejection.
x.reject = matrix(nrow=2, ncol=length(n_range))
x.reject[1,] = h0 - 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)
x.reject[2,] = h0 + 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)

# Power.
for(x in seq_along(x_range)){
  for(n in seq_along(n_range)){
    
    if(x_range[x] >= h0){
    auc.upper = pnorm(x.reject[2,n], x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(x.reject[1,n], x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}
    else{
    auc.upper = pnorm(-x.reject[2,n], -x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(-x.reject[1,n], -x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}}} #need abs here for some reason, otherwise beta is negative

# Concatetate columns (rows would require transpose: t(power)); create data
power = as.vector(power)
n     = rep(n_range, length(x_range))
x     = rep(x_range, each=length(n_range))
dat   = data.frame(x=x, n=n, power=power)

p.contour1 = ggplot(dat, aes(x=x, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(breaks=seq(90,110,10), name=expression(paste(mu,"")))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        axis.title.x=element_blank(),
        #axis.title.y=element_blank(),
        #axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste("H0: ",mu==100,",  ",sigma==10,",  ",alpha==0.05)))

# Plot 2 ####
h0 = 100; alpha = 0.05; sigma = 15

x_range = seq(85,115,0.1)
n_range = seq(5,55,1)

power = matrix(nrow=length(n_range), ncol=length(x_range))

# Values that would lead to h0 rejection.
x.reject = matrix(nrow=2, ncol=length(n_range))
x.reject[1,] = h0 - 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)
x.reject[2,] = h0 + 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)

# Power.
for(x in seq_along(x_range)){
  for(n in seq_along(n_range)){
    
    if(x_range[x] >= h0){
    auc.upper = pnorm(x.reject[2,n], x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(x.reject[1,n], x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}
    else{
    auc.upper = pnorm(-x.reject[2,n], -x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(-x.reject[1,n], -x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}}} #need abs here for some reason, otherwise beta is negative

# Concatetate columns (rows would require transpose: t(power)); create data
power = as.vector(power)
n     = rep(n_range, length(x_range))
x     = rep(x_range, each=length(n_range))
dat   = data.frame(x=x, n=n, power=power)

p.contour2 = ggplot(dat, aes(x=x, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(breaks=seq(90,110,10), name=expression(paste(mu,"")))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        #axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste("H0: ",mu==100,",  ",sigma==15,",  ",alpha==0.05)))

# Plot 3 ####
h0 = 100; alpha = 0.01; sigma = 15

x_range = seq(85,115,0.1)
n_range = seq(5,55,1)

power = matrix(nrow=length(n_range), ncol=length(x_range))

# Values that would lead to h0 rejection.
x.reject = matrix(nrow=2, ncol=length(n_range))
x.reject[1,] = h0 - 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)
x.reject[2,] = h0 + 1 * abs(qnorm(alpha/2,0,1))*sigma/sqrt(n_range)

# Power.
for(x in seq_along(x_range)){
  for(n in seq_along(n_range)){
    
    if(x_range[x] >= h0){
    auc.upper = pnorm(x.reject[2,n], x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(x.reject[1,n], x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}
    else{
    auc.upper = pnorm(-x.reject[2,n], -x_range[x], sigma/sqrt(n_range[n]))
    auc.lower = pnorm(-x.reject[1,n], -x_range[x], sigma/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}}} #need abs here for some reason, otherwise beta is negative

# Concatetate columns (rows would require transpose: t(power)); create data
power = as.vector(power)
n     = rep(n_range, length(x_range))
x     = rep(x_range, each=length(n_range))
dat   = data.frame(x=x, n=n, power=power)

p.contour3 = ggplot(dat, aes(x=x, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(breaks=seq(90,110,10), name=expression(paste(mu,"")))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        #legend.position="none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        plot.title=element_text(size=8))+
  ggtitle(expression(paste("H0: ",mu==100,",  ",sigma==15,",  ",alpha==0.01)))

p.contour1 | p.contour2 | p.contour3
```


```{r repeat sampdist plot, fig.height=4.2, fig.width=5}
set.seed(5)

mu=100; sigma=10; N=c(5, 15, 50); reps=100000

samdists= rbind(with(density(rnorm(reps,mu,sigma)), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[1],mu,sigma)))), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[2],mu,sigma)))), data.frame(x,y)),
                with(density(replicate(n=reps,mean(rnorm(N[3],mu,sigma)))), data.frame(x,y)))

samdists$l = rep(c("Population", "N = 5", "N = 15", "N = 50"), each=512) #512 is length of density()
samdists$l = factor(samdists$l, levels=c("N = 50", "N = 15", "N = 5", "Population"))

legend = ggplot()+
  theme_bw()+
  theme(axis.title=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), panel.grid=element_blank())+
  theme_void()+
  coord_fixed()+
  scale_x_continuous(limits=c(0,8))+
  scale_y_continuous(limits=c(0,6))+
  annotate("rect", xmin=0, xmax=0.8, ymin=4, ymax=4.8, size=1, alpha=0.2, fill=NA, color="darkorange")+
  annotate("rect", xmin=0, xmax=0.8, ymin=3, ymax=3.8, size=1, alpha=0.2, fill=NA, color="darkred")+
  annotate("rect", xmin=0, xmax=0.8, ymin=2, ymax=2.8, size=1, alpha=0.2, fill=NA, color="purple4")+
  annotate("rect", xmin=0, xmax=0.8, ymin=0, ymax=0.8, size=1, alpha=0.2, fill="gray40", color="black")+
  
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=4.4, label="N = 50")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=3.4, label="N = 15")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=2.4, label="N =  5")+
  annotate("text", hjust=0, vjust=0.5, size=3, x=1, y=0.4, label=expression(paste("Normal (",mu,", ",sigma,")")))+
  annotate("text", hjust=0, vjust=0.5, size=3, x=3.4, y=3.3, label=expression(paste("Normal (",mu,", ",frac(sigma,sqrt(N)),")")))+
  
  geom_segment(size=0.5, linetype="dotted", aes(x=3.3, xend=3.3, y=2, yend=4.8))+
  
  annotate("text", hjust=0, vjust=0, size=3, x=0, y=5.1, label=expression(bold("Distributions of m")))+
  annotate("text", hjust=0, vjust=0, size=3, x=0, y=1, label=expression(bold("Population")))

p.samdists = ggplot(data=samdists, aes(x=x, y=y, color=l, fill=l))+
  geom_segment(aes(x=mu,xend=mu,y=-0.01,yend=max(samdists$y)), size=1, color="navy", linetype="dashed")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=-0.02, label="mu", color="navy")+
  geom_area(size=1, alpha=0.2)+
  scale_fill_manual(values=c(NA,NA,NA,"gray40"), name="") +
  scale_color_manual(values=c("darkorange","darkred","purple4","black"), name="")+
  scale_x_continuous(name="X", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="Probability Density", limits=c(-0.05,NA))+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")+
  annotation_custom(ggplotGrob(legend), ymin=0.02, ymax=0.28, xmin=mu-3*sigma, xmax=95)

s1 = data.frame(x=c(rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma),rnorm(N[1],mu,sigma)),
                y=rep(1:5), each=N[1]) #5 samples
s2 = data.frame(x=c(rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma),rnorm(N[2],mu,sigma)),
                y=rep(1:5), each=N[2])
s3 = data.frame(x=c(rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma),rnorm(N[3],mu,sigma)),
                y=rep(1:5), each=N[3])

m1 = tapply(s1$x, s1$y, mean); m1 = data.frame(x=m1, y=1:5)
m2 = tapply(s2$x, s2$y, mean); m2 = data.frame(x=m2, y=1:5)
m3 = tapply(s3$x, s3$y, mean); m3 = data.frame(x=m3, y=1:5)

p.N1 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s1, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m1, aes(x=x,y=y), shape=22, size=4, color="black", fill="purple4")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="Sample #", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.title.x=element_blank(),
        aspect.ratio=1.2) #sufficient to set for one plot of the row

p.N2 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s2, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m2, aes(x=x,y=y), shape=22, size=4, color="black", fill="darkred")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank())

p.N3 = ggplot()+
  geom_segment(aes(x=mu,xend=mu,y=0.5,yend=5.5), color="navy", size=1, linetype="dashed")+
  geom_point(data=s3, aes(x=x,y=y), shape=21, size=3, color="black", fill="gray85")+
  geom_point(data=m3, aes(x=x,y=y), shape=22, size=4, color="black", fill="darkorange")+
  annotate(geom="text", size=5, hjust=0.5, vjust=1, parse=T, x=mu, y=0.4, label="mu", color="navy")+
  scale_x_continuous(name="", limits=c(mu-3*sigma,mu+3*sigma))+
  scale_y_continuous(name="", limit=c(0,5.5), breaks=1:5)+
  theme_bw()+
  theme(panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.title.x=element_blank())

(p.N1|p.N2|p.N3) / p.samdists
```


```{r z-statistic plot, fig.height=4, fig.width=5}
set.seed(5)

mu=100; sigma=10; N=c(5, 15, 50); reps=100000; alpha=0.05

samdists = cbind(rbind(with(density(replicate(n=reps,mean(rnorm(N[1],0,sigma)))), data.frame(x,y)),
                       with(density(replicate(n=reps,mean(rnorm(N[2],0,sigma)))), data.frame(x,y)),
                       with(density(replicate(n=reps,mean(rnorm(N[3],0,sigma)))), data.frame(x,y))),
                 rbind(with(density(replicate(n=reps,mean(rnorm(N[1],0,sigma))/(sigma/sqrt(N[1])))), data.frame(xz=x,yz=y)),
                       with(density(replicate(n=reps,mean(rnorm(N[2],0,sigma))/(sigma/sqrt(N[2])))), data.frame(xz=x,yz=y)),
                       with(density(replicate(n=reps,mean(rnorm(N[3],0,sigma))/(sigma/sqrt(N[3])))), data.frame(xz=x,yz=y))))

# Normalize x-axis to sigma
samdists$x = samdists$x/sigma

samdists$n = rep(c("N = 5", "N = 15", "N = 50"), each=512)
samdists$n = factor(samdists$n, levels=c("N = 5", "N = 15", "N = 50"))

# technially unnecessary as zcrit independent of N here, but for t-dist will depend on N
zcrit = cbind(c(-1,1) * abs(qnorm(alpha/2,0,1)),
              c(-1,1) * abs(qnorm(alpha/2,0,1)),
              c(-1,1) * abs(qnorm(alpha/2,0,1)))

samdists$low[samdists$n=="N = 5"]  = ifelse(samdists$xz[samdists$n=="N = 5"]<zcrit[1,1], samdists$xz[samdists$n=="N = 5"], NA)
samdists$low[samdists$n=="N = 15"] = ifelse(samdists$xz[samdists$n=="N = 15"]<zcrit[1,2], samdists$xz[samdists$n=="N = 15"], NA)
samdists$low[samdists$n=="N = 50"] = ifelse(samdists$xz[samdists$n=="N = 50"]<zcrit[1,3], samdists$xz[samdists$n=="N = 50"], NA)

samdists$high[samdists$n=="N = 5"]  = ifelse(samdists$xz[samdists$n=="N = 5"]>zcrit[2,1], samdists$xz[samdists$n=="N = 5"], NA)
samdists$high[samdists$n=="N = 15"] = ifelse(samdists$xz[samdists$n=="N = 15"]>zcrit[2,2], samdists$xz[samdists$n=="N = 15"], NA)
samdists$high[samdists$n=="N = 50"] = ifelse(samdists$xz[samdists$n=="N = 50"]>zcrit[2,3], samdists$xz[samdists$n=="N = 50"], NA)

samdists$zcrit[samdists$n=="N = 5"]  = c(zcrit[1,1], zcrit[2,1], rep(NA,dim(samdists)[1]/3-2))
samdists$zcrit[samdists$n=="N = 15"] = c(zcrit[1,2], zcrit[2,2], rep(NA,dim(samdists)[1]/3-2))
samdists$zcrit[samdists$n=="N = 50"] = c(zcrit[1,3], zcrit[2,3], rep(NA,dim(samdists)[1]/3-2))

p.samdismean = ggplot(data=samdists)+
  geom_area(aes(x=x, y=y, color=n, fill=NA), size=1)+
  facet_grid(. ~ n)+
  scale_color_manual(values=c("purple4","darkred","darkorange"), name="")+
  scale_fill_manual(values=c("purple4","darkred","darkorange"), name="")+
  # Design
  scale_x_continuous(limits=c(-1.5,1.5), breaks=-1:1, name=expression(paste(frac(m-mu,sigma))))+
  scale_y_continuous(name="Density")+
  theme_bw()+
  theme(#aspect.ratio=1,
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")

p.zstat = ggplot(data=samdists)+
  geom_area(aes(x=xz, y=yz, color=n, fill=NA), size=1)+
  facet_grid(. ~ n)+
  geom_area(aes(x=low, y=yz, color=NA, fill=n), size=1, alpha=0.4)+
  geom_area(aes(x=high, y=yz, color=NA, fill=n), size=1, alpha=0.4)+
  geom_segment(aes(x=zcrit, xend=zcrit, y=0, yend=max(samdists$yz)))+
  scale_color_manual(values=c("darkred","purple4","darkorange"), name="")+ #for whatever reason...
  scale_fill_manual(values=c("darkred","purple4","darkorange"), name="")+  #1 and 2 are switched in plot
  # Design
  #scale_x_continuous(limits=c(-5,5), breaks=-3:3, name=expression(paste((m-mu)/(sigma/sqrt(N)))))+
  scale_x_continuous(limits=c(-5,5), breaks=-3:3, name=expression(paste(frac(m-mu,sigma/sqrt(N)))))+
  scale_y_continuous(name="Density")+
  theme_bw()+
  theme(#aspect.ratio=1,
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")

p.samdismean / p.zstat
```


```{r t-statistic plot, fig.height=6, fig.width=5}
set.seed(5)

mu=100; sigma=10; N=c(5, 15, 50); reps=100000; alpha=0.05

get_t <- function(N,sigma){
  x = rnorm(N,0,sigma)
  t = mean(x)/(sd(x)/sqrt(N))
  return(t)}

samdists = cbind(rbind(with(density(replicate(n=reps,mean(rnorm(N[1],0,sigma)))), data.frame(xm=x,ym=y)),
                       with(density(replicate(n=reps,mean(rnorm(N[2],0,sigma)))), data.frame(xm=x,ym=y)),
                       with(density(replicate(n=reps,mean(rnorm(N[3],0,sigma)))), data.frame(xm=x,ym=y))),
                 rbind(with(density(replicate(n=reps,sd(rnorm(N[1],0,sigma))-sigma)), data.frame(xsd=x,ysd=y)),
                       with(density(replicate(n=reps,sd(rnorm(N[2],0,sigma))-sigma)), data.frame(xsd=x,ysd=y)),
                       with(density(replicate(n=reps,sd(rnorm(N[3],0,sigma))-sigma)), data.frame(xsd=x,ysd=y))),
                 rbind(with(density(replicate(n=reps,get_t(N[1],sigma))), data.frame(xt=x,yt=y)),
                       with(density(replicate(n=reps,get_t(N[2],sigma))), data.frame(xt=x,yt=y)),
                       with(density(replicate(n=reps,get_t(N[3],sigma))), data.frame(xt=x,yt=y))))

# Normalize x-axis to sigma
samdists$xm = samdists$xm/sigma
samdists$xsd = samdists$xsd/sigma

samdists$n = rep(c("N = 5", "N = 15", "N = 50"), each=512)
samdists$n = factor(samdists$n, levels=c("N = 5", "N = 15", "N = 50"))
samdists$df = rep(c("df = N-1 = 4", "df = N-1 = 14", "df = N-1 = 49"), each=512)
samdists$df = factor(samdists$df, levels=c("df = N-1 = 4", "df = N-1 = 14", "df = N-1 = 49"))

tcrit = cbind(c(-1,1) * abs(qt(alpha/2,N[1]-1)),
              c(-1,1) * abs(qt(alpha/2,N[2]-1)),
              c(-1,1) * abs(qt(alpha/2,N[3]-1)))

samdists$low[samdists$n=="N = 5"]  = ifelse(samdists$xt[samdists$n=="N = 5"]<tcrit[1,1], samdists$xt[samdists$n=="N = 5"], NA)
samdists$low[samdists$n=="N = 15"] = ifelse(samdists$xt[samdists$n=="N = 15"]<tcrit[1,2], samdists$xt[samdists$n=="N = 15"], NA)
samdists$low[samdists$n=="N = 50"] = ifelse(samdists$xt[samdists$n=="N = 50"]<tcrit[1,3], samdists$xt[samdists$n=="N = 50"], NA)

samdists$high[samdists$n=="N = 5"]  = ifelse(samdists$xt[samdists$n=="N = 5"]>tcrit[2,1], samdists$xt[samdists$n=="N = 5"], NA)
samdists$high[samdists$n=="N = 15"] = ifelse(samdists$xt[samdists$n=="N = 15"]>tcrit[2,2], samdists$xt[samdists$n=="N = 15"], NA)
samdists$high[samdists$n=="N = 50"] = ifelse(samdists$xt[samdists$n=="N = 50"]>tcrit[2,3], samdists$xt[samdists$n=="N = 50"], NA)

samdists$tcrit[samdists$n=="N = 5"]  = c(tcrit[1,1], tcrit[2,1], rep(NA,dim(samdists)[1]/3-2))
samdists$tcrit[samdists$n=="N = 15"] = c(tcrit[1,2], tcrit[2,2], rep(NA,dim(samdists)[1]/3-2))
samdists$tcrit[samdists$n=="N = 50"] = c(tcrit[1,3], tcrit[2,3], rep(NA,dim(samdists)[1]/3-2))

p.samdistmean = ggplot(data=samdists)+
  geom_area(aes(x=xm, y=ym, color=n, fill=NA), size=1)+
  facet_grid(. ~ n)+
  scale_color_manual(values=c("purple4","darkred","darkorange"), name="")+
  scale_fill_manual(values=c("purple4","darkred","darkorange"), name="")+
  # Design
  scale_x_continuous(limits=c(-1.5,1.5), breaks=-1:1, name=expression(paste(frac(m-mu,sigma))))+
  scale_y_continuous(name="Density")+
  theme_bw()+
  theme(#aspect.ratio=1,
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")

p.samdistsd = ggplot(data=samdists)+
  geom_area(aes(x=xsd, y=ysd, color=n, fill=NA), size=1)+
  facet_grid(. ~ n)+
  scale_color_manual(values=c("purple4","darkred","darkorange"), name="")+
  scale_fill_manual(values=c("purple4","darkred","darkorange"), name="")+
  # Design
  scale_x_continuous(limits=c(-1.5,1.5), breaks=-1:1, name=expression(paste(frac(s-sigma,sigma))))+
  scale_y_continuous(name="Density")+
  theme_bw()+
  theme(#aspect.ratio=1,
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")

p.tstat = ggplot(data=samdists)+
  geom_area(aes(x=xt, y=yt, color=n, fill=NA), size=1)+
  facet_grid(. ~ n)+
  geom_area(aes(x=low, y=yt, color=NA, fill=n), size=1, alpha=0.4)+
  geom_area(aes(x=high, y=yt, color=NA, fill=n), size=1, alpha=0.4)+
  geom_segment(aes(x=tcrit, xend=tcrit, y=0, yend=max(samdists$yt)))+
  scale_color_manual(values=c("darkred","purple4","darkorange"), name="")+ #for whatever reason...
  scale_fill_manual(values=c("darkred","purple4","darkorange"), name="")+  #1 and 2 are switched in plot
  # Design
  #scale_x_continuous(limits=c(-5,5), breaks=-3:3, name=expression(paste((m-mu)/(s/sqrt(N))==t)))+
  scale_x_continuous(limits=c(-5,5), breaks=-3:3, name=expression(paste(frac(m-mu,s/sqrt(N)))))+
  scale_y_continuous(name="Density")+
  theme_bw()+
  theme(#aspect.ratio=1,
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position="none")

p.samdistmean / p.samdistsd / p.tstat
```


```{r CI plot zstat, fig.height=4.8, fig.width=7.2}
# Params
set.seed(5); mu=100; sigma=10; N=15; reps=100000

# Create sample (x-scale: raw), popdis and samdis (x-scale: SEM).
sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)) #sample
popdis = with(density(rnorm(reps,0,1*sqrt(N))), data.frame(x,y)) #popdis centred on zero
samdis = with(density(rnorm(reps,0,1)), data.frame(x,y)) #samdis centred on zero

# Add to samdis: x-values centred on lower and upper CI limits.
alpha = 0.05
shift = qnorm(c(alpha/2, 1-alpha/2),0,1) # CI limits
samdis$xl = samdis$x + shift[1]          # left samdis
samdis$xr = samdis$x + shift[2]          # right samdis

# Add to samdis: y-values to stack everything in one plot.
shiftup = max(samdis$y)*1.25
samdis$yl = samdis$y + shiftup*2 # CI, right samdis, left samdis are spaced 1.25 * (height of samdis) on y
samdis$yr = samdis$y + shiftup   # ... i.e. the two samdis are spaced 0.25 * (height of samdis) on y

# Create data: p-value curve.
x = c(seq(-35/(sigma/sqrt(N)), 35/(sigma/sqrt(N)), 0.01), 0)
p = vector(length=length(x))

for (i in 1:length(x)){
  if (x[i] < 0){
    p[i] = pnorm(x[i],0,1) * 2}
  else {
    p[i] = (1 - pnorm(x[i],0,1)) * 2}}

pcurve.z = data.frame(x,p)

# Plotting params.
xlimits  = c(-30,30)/(sigma/sqrt(N))
mdev     = abs(mean(sample$x) - c(mu-30, mu+30)) # to make 0 on test stat scale...
mdev[1]  = -mdev[1]                              # ...align with mean(sample$x) on raw scale
xlimits2 = mdev/(sigma/sqrt(N))
xbreaks  = -5:5
xbreaks2 = xbreaks
xcutoff  = 0       
xlabels  = c(expression(paste("Distance from ",mu," / (",sigma/sqrt(N),")")),
             expression(paste("Distance from ",m," / (",sigma/sqrt(N),")")))

p.pop1 = ggplot()+
  geom_area(data=popdis, aes(x=x, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_area(data=samdis, aes(x=x, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=xlimits, breaks=xbreaks, name=xlabels[1])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample1 = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.ci1 = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl, ymin=shiftup*2, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl>xcutoff,xl,NA), ymin=shiftup*2, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Right sampling distribution and area
  geom_ribbon(aes(x=xr, ymin=shiftup, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr<xcutoff,xr,NA), ymin=shiftup, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=xcutoff)+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift[1], xend=shift[1], y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #left
  geom_segment(aes(x=shift[2], xend=shift[2], y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #right
  # CI & Point Estimate
  geom_segment(aes(x=shift[1], xend=shift[2], y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff, y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2, breaks=xbreaks2, name=xlabels[2])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve1 = ggplot(data=pcurve.z, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift[1], xend=shift[2], y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff, y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=min(xlimits2), y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2, breaks=xbreaks2, name=xlabels[2])+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.2), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

shift.r      = mean(sample$x) + shift * (sigma/sqrt(N))
xlimits.r    = xlimits * (sigma/sqrt(N))
xlimits2.r   = xlimits2 * (sigma/sqrt(N)) + mean(sample$x)
xbreaks.r    = seq(-20,20,10)
xbreaks2.r   = xbreaks.r+100
xcutoff.r    = mean(sample$x)      
xlabels.r    = c(expression(paste("Distance from ",mu,"")), "X")
# Convert x-scale of data for plot 1 (zero centred)
popdis$x.r   = popdis$x * (sigma/sqrt(N))
samdis$x.r   = samdis$x * (sigma/sqrt(N))
# Convert x-scale of data for plots 3,4 (mu centred)
samdis$xl.r  = samdis$xl * (sigma/sqrt(N)) + mean(sample$x)
samdis$xr.r  = samdis$xr * (sigma/sqrt(N)) + mean(sample$x)
pcurve.z$x.r = pcurve.z$x * (sigma/sqrt(N)) + mean(sample$x)

p.pop2 = ggplot()+
  geom_area(data=popdis, aes(x=x.r, y=y), size=1, color="black", fill="gray40", alpha=0.2)+
  geom_area(data=samdis, aes(x=x.r, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=xlimits.r, breaks=xbreaks.r, name=xlabels.r[1])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample2 = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.ci2 = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl.r, ymin=shiftup*2, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl.r>xcutoff.r,xl.r,NA), ymin=shiftup*2, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Right sampling distribution and area
  geom_ribbon(aes(x=xr.r, ymin=shiftup, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr.r<xcutoff.r,xr.r,NA), ymin=shiftup, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=xcutoff.r)+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift.r[1], xend=shift.r[1], y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #left
  geom_segment(aes(x=shift.r[2], xend=shift.r[2], y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #right
  # CI & Point Estimate
  geom_segment(aes(x=shift.r[1], xend=shift.r[2], y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff.r, y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2.r, breaks=xbreaks2.r, name=xlabels.r[2])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve2 = ggplot(data=pcurve.z, aes(x=x.r, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift.r, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift.r[1], xend=shift.r[2], y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff.r, y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=min(xlimits2.r), y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2.r, breaks=xbreaks2.r, name=xlabels.r[2])+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.2), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.cipcurve2 = p.cipcurve2+
  theme(axis.title.y=element_blank())

(p.pop1 / p.sample1 / p.ci1 / p.cipcurve1) | (p.pop2 / p.sample2 / p.ci2 / p.cipcurve2)
```


```{r CI plot tstat, fig.height=4.8, fig.width=7.2}
# Params
set.seed(5); mu=100; sigma=10; N=15; reps=100000

# Create sample (x-scale: raw), popdis and samdis (x-scale: SEM).
sample = data.frame(x=rnorm(N,mu,sigma),y=rep(0,N)); s=sd(sample$x) #sample
samdis = with(density(rt(reps,N-1)), data.frame(x,y)) #samdis centred on zero

# Add to samdis: x-values centred on lower and upper CI limits.
alpha = 0.05
shift = qt(c(alpha/2, 1-alpha/2),N-1)    # CI limits
samdis$xl = samdis$x + shift[1]          # left samdis
samdis$xr = samdis$x + shift[2]          # right samdis

# Add to samdis: y-values to stack everything in one plot.
shiftup = max(samdis$y)*1.25
samdis$yl = samdis$y + shiftup*2 # CI, right samdis, left samdis are spaced 1.25 * (height of samdis) on y
samdis$yr = samdis$y + shiftup   # ... i.e. the two samdis are spaced 0.25 * (height of samdis) on y

# Create data: p-value curve.
x = c(seq(70,130,0.1), mean(sample$x))
p = vector(length=length(x))

for (i in 1:length(x)){
  p[i] = t.test(sample$x, mu=x[i])$p.value}

pcurve.z = data.frame(x,p)
pcurve.z$x = (pcurve.z$x - mean(sample$x))/(s/sqrt(N))

# Plotting params.
xlimits  = c(-30,30)/(s/sqrt(N)) 
mdev     = abs(mean(sample$x) - c(mu-30, mu+30)) # to make 0 on test stat scale...
mdev[1]  = -mdev[1]                              # ...align with mean(sample$x) on raw scale
xlimits2 = mdev/(sigma/sqrt(N))
xbreaks  = -5:5
xbreaks2 = xbreaks
xcutoff  = 0       
xlabels  = xlabels  = c(expression(paste("Distance from ",mu," / (",s/sqrt(N),")")),
             expression(paste("Distance from ",m," / (",s/sqrt(N),")")))

p.pop1 = ggplot()+
  geom_area(data=samdis, aes(x=x, y=y), size=1, color="darkred", fill=NA)+
  geom_vline(xintercept=0, color="navy", linetype="dashed")+
  theme_bw()+
  scale_x_continuous(limits=xlimits, breaks=xbreaks, name=xlabels[1])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

p.sample1 = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.ci1 = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl, ymin=shiftup*2, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl>xcutoff,xl,NA), ymin=shiftup*2, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Right sampling distribution and area
  geom_ribbon(aes(x=xr, ymin=shiftup, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr<xcutoff,xr,NA), ymin=shiftup, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=xcutoff)+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift[1], xend=shift[1], y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #left
  geom_segment(aes(x=shift[2], xend=shift[2], y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #right
  # CI & Point Estimate
  geom_segment(aes(x=shift[1], xend=shift[2], y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff, y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2, breaks=xbreaks2, name=xlabels[2])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve1 = ggplot(data=pcurve.z, aes(x=x, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift[1], xend=shift[2], y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff, y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=min(xlimits2), y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2, breaks=xbreaks2, name=xlabels[2])+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.2), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

shift.r      = mean(sample$x) + shift * (s/sqrt(N))
xlimits.r    = xlimits #stays same, cannot know t-dist raw scale before knowing s
xlimits2.r   = xlimits2 * (s/sqrt(N)) + mean(sample$x)
xbreaks.r    = xbreaks #stays same, see above
xbreaks2.r   = seq(-20,20,10)+100
xcutoff.r    = mean(sample$x)      
xlabels.r    = c(expression(paste("Distance from ",mu,"")), "X")
# Convert x-scale of data for plot 1 (zero centred)
popdis$x.r   = popdis$x #stays same, see above
samdis$x.r   = samdis$x #stays same, see above
# Convert x-scale of data for plots 3,4 (mu centred)
samdis$xl.r  = samdis$xl * (s/sqrt(N)) + mean(sample$x)
samdis$xr.r  = samdis$xr * (s/sqrt(N)) + mean(sample$x)
pcurve.z$x.r = pcurve.z$x * (s/sqrt(N)) + mean(sample$x)

#p.pop2 = ggplot()+
#  geom_area(data=samdis, aes(x=x.r, y=y), size=1, color="darkred", fill=NA)+
#  geom_vline(xintercept=0, color="navy", linetype="dashed")+
#  theme_bw()+
#  scale_x_continuous(limits=xlimits.r, breaks=xbreaks.r, name=xlabels[1])+
#  scale_y_continuous(name="")+
#  theme(axis.text.y=element_blank(),
#        axis.ticks.y=element_blank(),
#        panel.grid=element_blank(),
#        aspect.ratio=0.1)

p.sample2 = ggplot(data=sample, aes(x=x, y=y))+
  geom_point(size=3, shape=21, fill="gray85")+
  geom_vline(xintercept=mean(sample$x))+
  geom_point(size=4, shape=22, fill="darkred", aes(x=mean(sample$x), y=0))+
  theme_bw()+
  scale_x_continuous(limits=c(70,130), breaks=seq(80,120,10), name="X")+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.05)

p.ci2 = ggplot(data=samdis)+
  # Left sampling distribution and area
  geom_ribbon(aes(x=xl.r, ymin=shiftup*2, ymax=yl), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xl.r>xcutoff.r,xl.r,NA), ymin=shiftup*2, ymax=yl), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Right sampling distribution and area
  geom_ribbon(aes(x=xr.r, ymin=shiftup, ymax=yr), color="darkred", fill="white", size=1, alpha=1)+
  geom_ribbon(aes(x=ifelse(xr.r<xcutoff.r,xr.r,NA), ymin=shiftup, ymax=yr), color=NA, fill="darkred", size=1, alpha=0.4)+
  # Vertical line sample mean
  geom_vline(xintercept=xcutoff.r)+
  # Vertical line sampling distributions mean
  geom_segment(aes(x=shift.r[1], xend=shift.r[1], y=max(samdis$yl), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #left
  geom_segment(aes(x=shift.r[2], xend=shift.r[2], y=max(samdis$yr), yend=0.1*max(samdis$y)), linetype="dashed", color="navy")+ #right
  # CI & Point Estimate
  geom_segment(aes(x=shift.r[1], xend=shift.r[2], y=0, yend=0), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff.r, y=0), shape=22, color="darkred", fill="darkred", size=4)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2.r, breaks=xbreaks2.r, name=xlabels.r[2])+
  scale_y_continuous(name="")+
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=max(samdis$yl)*0.1/max(samdis$y)) #scales to pvalue plot, which had ratio max(samdis$y)*0.1/max(samdis$y) = 0.1

p.cipcurve2 = ggplot(data=pcurve.z, aes(x=x.r, y=p))+
  # p curve
  geom_line(size=1, color="darkred", alpha=0.4)+
  # Highlights
  geom_vline(xintercept=shift.r, color="navy", linetype="dashed")+
  geom_hline(yintercept=alpha, color="black")+
  # CI (might be too much)
  geom_segment(aes(x=shift.r[1], xend=shift.r[2], y=alpha, yend=alpha), color="darkred", size=1.5)+
  geom_point(aes(x=xcutoff.r, y=alpha), shape=22, color="darkred", fill="darkred", size=4)+
  # Legend
  annotate("text", size=3, label=expression(paste(alpha,"  =  0.05")), hjust=0, vjust=0, x=min(xlimits2.r), y=alpha+0.04)+
  # Design
  theme_bw()+
  scale_x_continuous(limits=xlimits2.r, breaks=xbreaks2.r, name=xlabels.r[2])+
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,0.2), name="p-value")+
  theme(panel.grid=element_blank(),
        aspect.ratio=1/3)

p.cipcurve2 = p.cipcurve2+
  theme(axis.title.y=element_blank())

placeholder = ggplot()+
  theme_minimal()+
  scale_x_continuous(limits=xlimits, breaks=xbreaks, name=xlabels[1])+
  scale_y_continuous(name="")+
  theme(axis.title.x=element_text(color="white"),
        axis.text.x=element_text(color="white"),
        #axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid=element_blank(),
        aspect.ratio=0.1)

(p.pop1 / p.sample1 / p.ci1 / p.cipcurve1) | (placeholder / p.sample2 / p.ci2 / p.cipcurve2)
```


```{r power contour d, fig.height=4.6, fig.width=6.5}
h0 = 0; alpha = 0.05; sigma = c(10,20)

x_range = seq(-2*max(sigma),2*max(sigma),0.1)
n_range = seq(5,55,1)

# SIGMA[1]
power = matrix(nrow=length(n_range), ncol=length(x_range))
powert= matrix(nrow=length(n_range), ncol=length(x_range)) #t-test

# Values that would lead to h0 rejection.
x.reject = matrix(nrow=2, ncol=length(n_range))
x.reject[1,] = h0 - 1 * abs(qnorm(alpha/2,0,1))*sigma[1]/sqrt(n_range)
x.reject[2,] = h0 + 1 * abs(qnorm(alpha/2,0,1))*sigma[1]/sqrt(n_range)

# Power.
for(x in seq_along(x_range)){
  for(n in seq_along(n_range)){
    powert[n,x] = power.t.test(n=n_range[n], delta=x_range[x], sd=sigma[1], power=NULL, type="one.sample")$power #t-test
    if(x_range[x] >= h0){
    auc.upper = pnorm(x.reject[2,n], x_range[x], sigma[1]/sqrt(n_range[n]))
    auc.lower = pnorm(x.reject[1,n], x_range[x], sigma[1]/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}
    else{
    auc.upper = pnorm(-x.reject[2,n], -x_range[x], sigma[1]/sqrt(n_range[n]))
    auc.lower = pnorm(-x.reject[1,n], -x_range[x], sigma[1]/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}}} #need abs here for some reason, otherwise beta is negative

# Concatetate columns (rows would require transpose: t(power)); create data
power = as.vector(power)
powert= as.vector(powert) #t-test
n     = rep(n_range, length(x_range))
x     = rep(x_range, each=length(n_range))
d     = x/sigma[1]
dat   = data.frame(x=x, d=d, n=n, power=power, powert=powert)

p.contour.r1 = ggplot(dat, aes(x=x, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[1]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2*max(sigma),2*max(sigma)), breaks=seq(-2*max(sigma),2*max(sigma),20), name=expression(paste("Distance from H0")))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        axis.title.x=element_blank(),
        #axis.title.y=element_blank(),
        #axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==10,",  ",alpha==0.05," (z-test)")))

p.contour.d1 = ggplot(dat, aes(x=d, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[1]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2,2), breaks=seq(-2,2,1), name=expression(paste("Distance from H0 / ",sigma)))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==10,",  ",alpha==0.05," (z-test)")))

p.contour.d1t = ggplot(dat, aes(x=d, y=n))+
  geom_raster(aes(fill=powert))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[1]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2,2), breaks=seq(-2,2,1), name=expression(paste("Distance from H0 / ",sigma)))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==10,",  ",alpha==0.05," (t-test)")))

# SIGMA[2]
power = matrix(nrow=length(n_range), ncol=length(x_range))
powert= matrix(nrow=length(n_range), ncol=length(x_range)) #t-test

# Values that would lead to h0 rejection.
x.reject = matrix(nrow=2, ncol=length(n_range))
x.reject[1,] = h0 - 1 * abs(qnorm(alpha/2,0,1))*sigma[2]/sqrt(n_range)
x.reject[2,] = h0 + 1 * abs(qnorm(alpha/2,0,1))*sigma[2]/sqrt(n_range)

# Power.
for(x in seq_along(x_range)){
  for(n in seq_along(n_range)){
    powert[n,x] = power.t.test(n=n_range[n], delta=x_range[x], sd=sigma[2], power=NULL, type="one.sample")$power #t-test
    if(x_range[x] >= h0){
    auc.upper = pnorm(x.reject[2,n], x_range[x], sigma[2]/sqrt(n_range[n]))
    auc.lower = pnorm(x.reject[1,n], x_range[x], sigma[2]/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}
    else{
    auc.upper = pnorm(-x.reject[2,n], -x_range[x], sigma[2]/sqrt(n_range[n]))
    auc.lower = pnorm(-x.reject[1,n], -x_range[x], sigma[2]/sqrt(n_range[n]))
    power[n,x] = 1-abs(auc.upper-auc.lower)}}} #need abs here for some reason, otherwise beta is negative

# Concatetate columns (rows would require transpose: t(power)); create data
power = as.vector(power)
powert= as.vector(powert) #t-test
n     = rep(n_range, length(x_range))
x     = rep(x_range, each=length(n_range))
d     = x/sigma[2]
dat   = data.frame(x=x, d=d, n=n, power=power, powert=powert)

p.contour.r2 = ggplot(dat, aes(x=x, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[2]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2*max(sigma),2*max(sigma)), breaks=seq(-2*max(sigma),2*max(sigma),20), name=expression(paste("Distance from H0")))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        #axis.title.x=element_blank(),
        #axis.title.y=element_blank(),
        #axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==20,",  ",alpha==0.05," (z-test)")))

p.contour.d2 = ggplot(dat, aes(x=d, y=n))+
  geom_raster(aes(fill=power))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[2]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2,2), breaks=seq(-2,2,1), name=expression(paste("Distance from H0 / ",sigma)))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        #axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==20,",  ",alpha==0.05," (z-test)")))

p.contour.d2t = ggplot(dat, aes(x=d, y=n))+
  geom_raster(aes(fill=powert))+
  scale_fill_continuous(type="viridis", name=expression(paste("Power (",1-beta,")")))+
  geom_vline(xintercept=h0, color="white", linetype="dotted")+
  #annotate("text", hjust=0, vjust=1, x=min(x_range), y=max(n_range), label=expression(paste(sigma[1]==10,"cm, ",alpha==0.05)))+
  theme_bw()+
  scale_x_continuous(limits=c(-2,2), breaks=seq(-2,2,1), name=expression(paste("Distance from H0 / ",sigma)))+
  scale_y_continuous(breaks=seq(5,55,10), name=expression(paste(N)))+
  theme(panel.grid=element_blank(),
        aspect.ratio=1,
        #axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=8))+
  ggtitle(expression(paste(sigma==20,",  ",alpha==0.05," (t-test)")))

(p.contour.r1 | p.contour.d1 | p.contour.d1t) / (p.contour.r2 | p.contour.d2 | p.contour.d2t + theme(legend.position="right"))
```
